---
title: "Coral Physiology Following Reciprocal Transplant"
author: "Serena Hackerott"
date: "1/1/2024"
output:
  html_notebook:
    toc: yes
    toc_float: yes
  html_document:
    toc: yes
    df_print: paged
---

# Setup

```{r Setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```


### Load Packages
```{r}
##Install Packages if Needed
if (!require("ggplot2")) install.packages("ggplot2")
if (!require("cowplot")) install.packages("cowplot")
if (!require("Rmisc")) install.packages("Rmisc")
if (!require("lme4")) install.packages("lme4")
if (!require("lmerTest")) install.packages("lmerTest")
if (!require("vegan")) install.packages("vegan")
if (!require("corrplot")) install.packages("corrplot")
if (!require("DHARMa")) install.packages("DHARMa")
if (!require("effectsize")) install.packages("effectsize")
if (!require("emmeans")) install.packages("emmeans")
if (!require("Hmisc")) install.packages("Hmisc")
if (!require("dplyr")) install.packages("dplyr")
if (!require("tidyr")) install.packages("tidyr")
if (!require("ggpubr")) install.packages("ggpubr")

##Load Packages
library(ggplot2) #Required for ggplots
library(cowplot) #Required for plotting panel figures
library(Rmisc) #Required for SummarySE function
library(lme4) #Required for mixed effects modeling
library(lmerTest) #Required for p values with lme4 model summaries
library(vegan) #Required for multivariate analysis PERM
library(corrplot) #Required for correlation plot
library(DHARMa) #Required to check residuals of mixed effects models
library(effectsize) #Required for eta_squared effect sizes
library(emmeans) #Required for pairwise comparisons 
library(Hmisc) #Required for correlations
library(dplyr) #Required for dataframe organization
library(tidyr) #Required for dataframe organization
library(ggpubr) #Required for stat brackets

```


### Graphing Parameters
```{r}
#Note: Run "Graphing Parameters" section from 01_ExperimentalSetup.Rmd file
```


# Sample Data and Metadata

### Load and Organize Data
```{r}
##Load Data
#Note: Physiological metrics calculated in 02_PhysiologyMetrics.R file
Coral<-read.csv("Outputs/CoralData.csv", header=TRUE)

##Set factor variables
Coral$TimeP<-factor(Coral$TimeP, levels=c("TP1", "TP2", "TP3", "TP4"))
Coral$Site<-factor(Coral$Site, levels=c("KL", "SS"))
Coral$Genotype<-factor(Coral$Genotype, levels=c("AC8", "AC10", "AC12"))
Coral$Orig<-factor(Coral$Orig, levels=c("N", "T"))
Coral$Origin<-factor(Coral$Origin, levels=c("Native", "Transplant"))
Coral$Site.Orig<-factor(Coral$Site.Orig, levels=c("KL.N", "KL.T", "SS.N", "SS.T"))


```


# Multivariate Analysis

### adonis OmegaSq Function
```{r}
#' Calculate (partial) Omega-squared (effect-size calculation) for PERMANOVA and add it to the input object
#'
#' @param adonisOutput An adonis object
#' @param partial Should partial omega-squared be calculated (sample size adjusted). Default TRUE
#' @return Original adonis object with the (partial) Omega-squared values added
#' @import vegan
#' @export
adonis_OmegaSq <- function(adonisOutput, partial = TRUE){
    if(!(is(adonisOutput, "adonis") || is(adonisOutput, "anova.cca")))
        stop("Input should be an adonis object")
    if (is(adonisOutput, "anova.cca")) {
        aov_tab <- adonisOutput
        aov_tab$MeanSqs <- aov_tab$SumOfSqs / aov_tab$Df
        aov_tab$MeanSqs[length(aov_tab$Df)] <- NA
    } else {
        aov_tab <- adonisOutput$aov.tab
    }
    heading <- attr(aov_tab, "heading")
    MS_res <- aov_tab[pmatch("Residual", rownames(aov_tab)), "MeanSqs"]
    SS_tot <- aov_tab[rownames(aov_tab) == "Total", "SumsOfSqs"]
    N <- aov_tab[rownames(aov_tab) == "Total", "Df"] + 1
    if(partial){
        omega <- apply(aov_tab, 1, function(x) (x["Df"]*(x["MeanSqs"]-MS_res))/(x["Df"]*x["MeanSqs"]+(N-x["Df"])*MS_res))
        aov_tab$parOmegaSq <- c(omega[1:(length(omega)-2)], NA, NA)
    } else {
        omega <- apply(aov_tab, 1, function(x) (x["SumsOfSqs"]-x["Df"]*MS_res)/(SS_tot+MS_res))
        aov_tab$OmegaSq <- c(omega[1:(length(omega)-2)], NA, NA)
    }
    if (is(adonisOutput, "adonis"))
        cn_order <- c("Df", "SumsOfSqs", "MeanSqs", "F.Model", "R2",
                      if (partial) "parOmegaSq" else "OmegaSq", "Pr(>F)")
    else
        cn_order <- c("Df", "SumOfSqs", "F", if (partial) "parOmegaSq" else "OmegaSq",
                      "Pr(>F)")
    aov_tab <- aov_tab[, cn_order]
    attr(aov_tab, "names") <- cn_order
    attr(aov_tab, "heading") <- heading
    if (is(adonisOutput, "adonis"))
        adonisOutput$aov.tab <- aov_tab
    else
        adonisOutput <- aov_tab
    return(adonisOutput)
}
```


### Check Correlation
```{r}
##Remove NA's
names(Coral)
Coral.rm<-na.omit(Coral)

##Correlation 
Phys.cor<-rcorr(as.matrix(Coral.rm[,-c(1:10)]), type="pearson")
Phys.cor

diag(Phys.cor$P)<-0

corrplot(Phys.cor$r, type="upper", order="hclust", 
         p.mat = Phys.cor$P, sig.level = 0.01, insig = "blank")

```

### All Timepoints
```{r}
##Standardize Variables for similar scales
Coral_St <- Coral.rm %>% mutate_at(c("TP_ug.cm2", "AFDW_mg.cm2", "Chl_ug.cm2"), ~(scale(.) %>% as.vector))

```


#### PERMANOVA
Checking for an overall effect of Origin or Site or Time, along with all interactions. Overall effect of Time alone (season) is not of main interest, but is predicted to interact with the effect of Origin as the time post-transplant increases.  
```{r}
##PERMANOVA
Coral.perm<-adonis2(vegdist(Coral_St[,c(11:13)], "euclidean")~ Coral_St$Origin*Coral_St$Site*Coral_St$TimeP, data=Coral_St, strata=Coral_St$Genotype, method="euclidean")

##Effect Size
adonis_OmegaSq(Coral.perm)

##Check dispersion by Origin
Orig_disp<-anova(betadisper(vegdist(Coral_St[,c(11:13)], "euclidean"), Coral_St$Origin))
Orig_disp

##Check dispersion by Site
Site_disp<-anova(betadisper(vegdist(Coral_St[,c(11:13)], "euclidean"), Coral_St$Site))
Site_disp

##Check dispersion by Time
Time_disp<-anova(betadisper(vegdist(Coral_St[,c(11:13)], "euclidean"), Coral_St$TimeP))
Time_disp

##Check dispersion by Origin:Site
Orig.Site_disp<-anova(betadisper(vegdist(Coral_St[,c(11:13)], "euclidean"), Coral_St$Origin:Coral_St$Site))
Orig.Site_disp

##Check dispersion by Origin:Time
Orig.Time_disp<-anova(betadisper(vegdist(Coral_St[,c(11:13)], "euclidean"), Coral_St$Origin:Coral_St$TimeP))
Orig.Time_disp

##Check dispersion by Site:Time
Site.Time_disp<-anova(betadisper(vegdist(Coral_St[,c(11:13)], "euclidean"), Coral_St$Site:Coral_St$TimeP))
Site.Time_disp

##Check dispersion by Origin:Site:Time
Orig.Site.Time_disp<-anova(betadisper(vegdist(Coral_St[,c(11:13)], "euclidean"), Coral_St$Origin:Coral_St$Site:Coral_St$TimeP))
Orig.Site.Time_disp

##Save results
PERM.res<-data.frame(adonis_OmegaSq(Coral.perm)[1:7,])
PERM.res$Predictor<-c("Origin", "Site", "Time", "Origin x Site", "Origin x Time", "Site x Time", "Site x Time x Origin")
PERM.res$p_DISP<-c(Orig_disp$`Pr(>F)`[1], Site_disp$`Pr(>F)`[1], Time_disp$`Pr(>F)`[1],
                   Orig.Site_disp$`Pr(>F)`[1], Orig.Time_disp$`Pr(>F)`[1], 
                   Site.Time_disp$`Pr(>F)`[1], Orig.Site.Time_disp$`Pr(>F)`[1])
PERM.res$Timepoint<-rep("All", nrow(PERM.res))

```

Due to significant interactions with Time, each time point will be analyzed separately to assess the effect of origin vs current site. 


### TP1
```{r}
##Subset Timepoint 1 
Coral_TP1<-subset(Coral.rm, TimeP=="TP1")

##Standardize Variables for similar scales
Coral_TP1 <- Coral_TP1 %>% mutate_at(c("TP_ug.cm2", "AFDW_mg.cm2", "Chl_ug.cm2"), ~(scale(.) %>% as.vector))

```


#### PERMANOVA
```{r}
##PERMANOVA
Coral.TP1.perm<-adonis2(vegdist(Coral_TP1[,c(11:13)], "euclidean")~ Coral_TP1$Origin * Coral_TP1$Site, data=Coral_TP1, strata=Coral_TP1$Genotype, method="euclidean")

##Effect Size
adonis_OmegaSq(Coral.TP1.perm)

##Check dispersion by Origin
TP1.disp_orig<-anova(betadisper(vegdist(Coral_TP1[,c(11:13)], "euclidean"), Coral_TP1$Origin))
TP1.disp_orig

##Check dispersion by Site
TP1.disp_site<-anova(betadisper(vegdist(Coral_TP1[,c(11:13)], "euclidean"), Coral_TP1$Site))
TP1.disp_site

##Check dispersion by Origin:Site
TP1.disp_os<-anova(betadisper(vegdist(Coral_TP1[,c(11:13)], "euclidean"), Coral_TP1$Origin:Coral_TP1$Site))
TP1.disp_os

##Save results
PERM_T1.res<-data.frame(adonis_OmegaSq(Coral.TP1.perm)[1:3,])
PERM_T1.res$Predictor<-c("Origin", "Site", "Origin x Site")
PERM_T1.res$p_DISP<-c(TP1.disp_orig$`Pr(>F)`[1], TP1.disp_site$`Pr(>F)`[1], TP1.disp_os$`Pr(>F)`[1])
```
Physiology differs significantly by Origin and the effect of Origin differs between Sites.

#### Effect Size
Calculate Effect Size of Origin for each Site
```{r}
##KL
##PERMANOVA
Coral.TP1.perm_KL<-adonis2(vegdist(Coral_TP1[which(Coral_TP1$Site=="KL"),c(11:13)], "euclidean")~ Coral_TP1$Origin[which(Coral_TP1$Site=="KL")], data=Coral_TP1[which(Coral_TP1$Site=="KL"),], strata=Coral_TP1$Genotype[which(Coral_TP1$Site=="KL")], method="euclidean")

##Effect Size
adonis_OmegaSq(Coral.TP1.perm_KL)

##Check dispersion by Origin
TP1.KL.disp_orig<-anova(betadisper(vegdist(Coral_TP1[which(Coral_TP1$Site=="KL"),c(11:13)], "euclidean"), Coral_TP1$Origin[which(Coral_TP1$Site=="KL")]))
TP1.KL.disp_orig

##SS
##PERMANOVA
Coral.TP1.perm_SS<-adonis2(vegdist(Coral_TP1[which(Coral_TP1$Site=="SS"),c(11:13)], "euclidean")~ Coral_TP1$Origin[which(Coral_TP1$Site=="SS")], data=Coral_TP1[which(Coral_TP1$Site=="SS"),], strata=Coral_TP1$Genotype[which(Coral_TP1$Site=="SS")], method="euclidean")

##Effect Size
adonis_OmegaSq(Coral.TP1.perm_SS)

##Check dispersion by Origin
TP1.SS.disp_orig<-anova(betadisper(vegdist(Coral_TP1[which(Coral_TP1$Site=="SS"),c(11:13)], "euclidean"), Coral_TP1$Origin[which(Coral_TP1$Site=="SS")]))
TP1.SS.disp_orig

##Save results
PERM_T1.site.res<-data.frame(adonis_OmegaSq(Coral.TP1.perm_KL)[1,])
PERM_T1.site.res<-rbind(PERM_T1.site.res, data.frame(adonis_OmegaSq(Coral.TP1.perm_SS)[1,]))
PERM_T1.site.res$Predictor<-c("KL Origin", "SS Origin")
PERM_T1.site.res$p_DISP<-c(TP1.KL.disp_orig$`Pr(>F)`[1], TP1.SS.disp_orig$`Pr(>F)`[1])

##Combine results 
PERM_T1.res<-rbind(PERM_T1.res, PERM_T1.site.res)
PERM_T1.res$Timepoint<-rep("TP1", nrow(PERM_T1.res))

```


### TP2
```{r}
##Subset Timepoint 2 
Coral_TP2<-subset(Coral.rm, TimeP=="TP2")

##Standardize Variables for similar scales
Coral_TP2 <- Coral_TP2 %>% mutate_at(c("TP_ug.cm2", "AFDW_mg.cm2", "Chl_ug.cm2"), ~(scale(.) %>% as.vector))

```

#### PERMANOVA
```{r}
##PERMANOVA
Coral.TP2.perm<-adonis2(vegdist(Coral_TP2[,c(11:13)], "euclidean")~ Coral_TP2$Origin * Coral_TP2$Site, data=Coral_TP2, strata=Coral_TP2$Genotype, method="euclidean")

##Effect Size
adonis_OmegaSq(Coral.TP2.perm)

##Check dispersion by Origin
TP2.disp_orig<-anova(betadisper(vegdist(Coral_TP2[,c(11:13)], "euclidean"), Coral_TP2$Origin))
TP2.disp_orig

##Check dispersion by Site
TP2.disp_site<-anova(betadisper(vegdist(Coral_TP2[,c(11:13)], "euclidean"), Coral_TP2$Site))
TP2.disp_site

##Check dispersion by Origin:Site
TP2.disp_os<-anova(betadisper(vegdist(Coral_TP2[,c(11:13)], "euclidean"), Coral_TP2$Origin:Coral_TP2$Site))
TP2.disp_os

##Save results
PERM_T2.res<-data.frame(adonis_OmegaSq(Coral.TP2.perm)[1:3,])
PERM_T2.res$Predictor<-c("Origin", "Site", "Origin x Site")
PERM_T2.res$p_DISP<-c(TP2.disp_orig$`Pr(>F)`[1], TP2.disp_site$`Pr(>F)`[1], TP2.disp_os$`Pr(>F)`[1])

```


#### Effect Size
Calculate Effect Size of Origin for each Site
```{r}
##KL
##PERMANOVA
Coral.TP2.perm_KL<-adonis2(vegdist(Coral_TP2[which(Coral_TP2$Site=="KL"),c(11:13)], "euclidean")~ Coral_TP2$Origin[which(Coral_TP2$Site=="KL")], data=Coral_TP2[which(Coral_TP2$Site=="KL"),], strata=Coral_TP2$Genotype[which(Coral_TP2$Site=="KL")], method="euclidean")

##Effect Size
adonis_OmegaSq(Coral.TP2.perm_KL)

##Check dispersion by Origin
TP2.KL.disp_orig<-anova(betadisper(vegdist(Coral_TP2[which(Coral_TP2$Site=="KL"),c(11:13)], "euclidean"), Coral_TP2$Origin[which(Coral_TP2$Site=="KL")]))
TP2.KL.disp_orig

##SS
##PERMANOVA
Coral.TP2.perm_SS<-adonis2(vegdist(Coral_TP2[which(Coral_TP2$Site=="SS"),c(11:13)], "euclidean")~ Coral_TP2$Origin[which(Coral_TP2$Site=="SS")], data=Coral_TP2[which(Coral_TP2$Site=="SS"),], strata=Coral_TP2$Genotype[which(Coral_TP2$Site=="SS")], method="euclidean")

##Effect Size
adonis_OmegaSq(Coral.TP2.perm_SS)

##Check dispersion by Origin
TP2.SS.disp_orig<-anova(betadisper(vegdist(Coral_TP2[which(Coral_TP2$Site=="SS"),c(11:13)], "euclidean"), Coral_TP2$Origin[which(Coral_TP2$Site=="SS")]))
TP2.SS.disp_orig

##Save results
PERM_T2.site.res<-data.frame(adonis_OmegaSq(Coral.TP2.perm_KL)[1,])
PERM_T2.site.res<-rbind(PERM_T2.site.res, data.frame(adonis_OmegaSq(Coral.TP2.perm_SS)[1,]))
PERM_T2.site.res$Predictor<-c("KL Origin", "SS Origin")
PERM_T2.site.res$p_DISP<-c(TP2.KL.disp_orig$`Pr(>F)`[1], TP2.SS.disp_orig$`Pr(>F)`[1])

##Combine results 
PERM_T2.res<-rbind(PERM_T2.res, PERM_T2.site.res)
PERM_T2.res$Timepoint<-rep("TP2", nrow(PERM_T2.res))

```


### TP3
```{r}
##Subset Timepoint 3 
Coral_TP3<-subset(Coral.rm, TimeP=="TP3")

##Standardize Variables for similar scales
Coral_TP3 <- Coral_TP3 %>% mutate_at(c("TP_ug.cm2", "AFDW_mg.cm2", "Chl_ug.cm2"), ~(scale(.) %>% as.vector))

```

#### PERMANOVA
```{r}
##PERMANOVA
Coral.TP3.perm<-adonis2(vegdist(Coral_TP3[,c(11:13)], "euclidean")~ Coral_TP3$Origin * Coral_TP3$Site, data=Coral_TP3, strata=Coral_TP3$Genotype, method="euclidean")

##Effect Size
adonis_OmegaSq(Coral.TP3.perm)

##Check dispersion by Origin
TP3.disp_orig<-anova(betadisper(vegdist(Coral_TP3[,c(11:13)], "euclidean"), Coral_TP3$Origin))
TP3.disp_orig

##Check dispersion by Site
TP3.disp_site<-anova(betadisper(vegdist(Coral_TP3[,c(11:13)], "euclidean"), Coral_TP3$Site))
TP3.disp_site

##Check dispersion by Origin:Site
TP3.disp_os<-anova(betadisper(vegdist(Coral_TP3[,c(11:13)], "euclidean"), Coral_TP3$Origin:Coral_TP3$Site))
TP3.disp_os

##Save results
PERM_T3.res<-data.frame(adonis_OmegaSq(Coral.TP3.perm)[1:3,])
PERM_T3.res$Predictor<-c("Origin", "Site", "Origin x Site")
PERM_T3.res$p_DISP<-c(TP3.disp_orig$`Pr(>F)`[1], TP3.disp_site$`Pr(>F)`[1], TP3.disp_os$`Pr(>F)`[1])

```


#### Effect Size
Calculate Effect Size of Origin for each Site
```{r}
##KL
##PERMANOVA
Coral.TP3.perm_KL<-adonis2(vegdist(Coral_TP3[which(Coral_TP3$Site=="KL"),c(11:13)], "euclidean")~ Coral_TP3$Origin[which(Coral_TP3$Site=="KL")], data=Coral_TP3[which(Coral_TP3$Site=="KL"),], strata=Coral_TP3$Genotype[which(Coral_TP3$Site=="KL")], method="euclidean")

##Effect Size
adonis_OmegaSq(Coral.TP3.perm_KL)

##Check dispersion by Origin
TP3.KL.disp_orig<-anova(betadisper(vegdist(Coral_TP3[which(Coral_TP3$Site=="KL"),c(11:13)], "euclidean"), Coral_TP3$Origin[which(Coral_TP3$Site=="KL")]))
TP3.KL.disp_orig

##SS
##PERMANOVA
Coral.TP3.perm_SS<-adonis2(vegdist(Coral_TP3[which(Coral_TP3$Site=="SS"),c(11:13)], "euclidean")~ Coral_TP3$Origin[which(Coral_TP3$Site=="SS")], data=Coral_TP3[which(Coral_TP3$Site=="SS"),], strata=Coral_TP3$Genotype[which(Coral_TP3$Site=="SS")], method="euclidean")

##Effect Size
adonis_OmegaSq(Coral.TP3.perm_SS)

##Check dispersion by Origin
TP3.SS.disp_orig<-anova(betadisper(vegdist(Coral_TP3[which(Coral_TP3$Site=="SS"),c(11:13)], "euclidean"), Coral_TP3$Origin[which(Coral_TP3$Site=="SS")]))
TP3.SS.disp_orig

##Save results
PERM_T3.site.res<-data.frame(adonis_OmegaSq(Coral.TP3.perm_KL)[1,])
PERM_T3.site.res<-rbind(PERM_T3.site.res, data.frame(adonis_OmegaSq(Coral.TP3.perm_SS)[1,]))
PERM_T3.site.res$Predictor<-c("KL Origin", "SS Origin")
PERM_T3.site.res$p_DISP<-c(TP3.KL.disp_orig$`Pr(>F)`[1], TP3.SS.disp_orig$`Pr(>F)`[1])

##Combine results 
PERM_T3.res<-rbind(PERM_T3.res, PERM_T3.site.res)
PERM_T3.res$Timepoint<-rep("TP3", nrow(PERM_T3.res))


```


### TP4
```{r}
##Subset Timepoint 4 
Coral_TP4<-subset(Coral.rm, TimeP=="TP4")

##Standardize Variables for similar scales
Coral_TP4 <- Coral_TP2 %>% mutate_at(c("TP_ug.cm2", "AFDW_mg.cm2", "Chl_ug.cm2"), ~(scale(.) %>% as.vector))

```

#### PERMANOVA
```{r}
##PERMANOVA
Coral.TP4.perm<-adonis2(vegdist(Coral_TP4[,c(11:13)], "euclidean")~ Coral_TP4$Origin * Coral_TP4$Site, data=Coral_TP4, strata=Coral_TP4$Genotype, method="euclidean")

##Effect Size
adonis_OmegaSq(Coral.TP4.perm)

##Check dispersion by Origin
TP4.disp_orig<-anova(betadisper(vegdist(Coral_TP4[,c(11:13)], "euclidean"), Coral_TP4$Origin))
TP4.disp_orig

##Check dispersion by Site
TP4.disp_site<-anova(betadisper(vegdist(Coral_TP4[,c(11:13)], "euclidean"), Coral_TP4$Site))
TP4.disp_site

##Check dispersion by Origin:Site
TP4.disp_os<-anova(betadisper(vegdist(Coral_TP4[,c(11:13)], "euclidean"), Coral_TP4$Origin:Coral_TP4$Site))
TP4.disp_os

##Save results
PERM_T4.res<-data.frame(adonis_OmegaSq(Coral.TP4.perm)[1:3,])
PERM_T4.res$Predictor<-c("Origin", "Site", "Origin x Site")
PERM_T4.res$p_DISP<-c(TP4.disp_orig$`Pr(>F)`[1], TP4.disp_site$`Pr(>F)`[1], TP4.disp_os$`Pr(>F)`[1])

```


#### Effect Size
Calculate Effect Size of Origin for each Site
```{r}
##KL
##PERMANOVA
Coral.TP4.perm_KL<-adonis2(vegdist(Coral_TP4[which(Coral_TP4$Site=="KL"),c(11:13)], "euclidean")~ Coral_TP4$Origin[which(Coral_TP4$Site=="KL")], data=Coral_TP4[which(Coral_TP4$Site=="KL"),], strata=Coral_TP4$Genotype[which(Coral_TP4$Site=="KL")], method="euclidean")

##Effect Size
adonis_OmegaSq(Coral.TP4.perm_KL)

##Check dispersion by Origin
TP4.KL.disp_orig<-anova(betadisper(vegdist(Coral_TP4[which(Coral_TP4$Site=="KL"),c(11:13)], "euclidean"), Coral_TP4$Origin[which(Coral_TP4$Site=="KL")]))
TP4.KL.disp_orig

##SS
##PERMANOVA
Coral.TP4.perm_SS<-adonis2(vegdist(Coral_TP4[which(Coral_TP4$Site=="SS"),c(11:13)], "euclidean")~ Coral_TP4$Origin[which(Coral_TP4$Site=="SS")], data=Coral_TP4[which(Coral_TP4$Site=="SS"),], strata=Coral_TP4$Genotype[which(Coral_TP4$Site=="SS")], method="euclidean")

##Effect Size
adonis_OmegaSq(Coral.TP4.perm_SS)

##Check dispersion by Origin
TP4.SS.disp_orig<-anova(betadisper(vegdist(Coral_TP4[which(Coral_TP4$Site=="SS"),c(11:13)], "euclidean"), Coral_TP4$Origin[which(Coral_TP4$Site=="SS")]))
TP4.SS.disp_orig

##Save results
PERM_T4.site.res<-data.frame(adonis_OmegaSq(Coral.TP4.perm_KL)[1,])
PERM_T4.site.res<-rbind(PERM_T4.site.res, data.frame(adonis_OmegaSq(Coral.TP4.perm_SS)[1,]))
PERM_T4.site.res$Predictor<-c("KL Origin", "SS Origin")
PERM_T4.site.res$p_DISP<-c(TP4.KL.disp_orig$`Pr(>F)`[1], TP4.SS.disp_orig$`Pr(>F)`[1])

##Combine results 
PERM_T4.res<-rbind(PERM_T4.res, PERM_T4.site.res)
PERM_T4.res$Timepoint<-rep("TP4", nrow(PERM_T4.res))

```


# Univariate 

### All Timepoints
Similar to the Multivariate analysis, checking for an overall effect of Origin or Site or Time, along with all interactions. Overall effect of Time alone (season) is not of main interest, but is predicted to interact with the effect of Origin as the time post-transplant increases.  

#### Protein
```{r}
##Check normality
hist(Coral$TP_ug.cm2)
shapiro.test(Coral$TP_ug.cm2)
#Normal

##Model 
#Function of Site and Origin and Time, with Genotype as a Random effect
#All Interactions included
Prot.lme<-lmer(TP_ug.cm2~Origin*Site*TimeP+(1|Genotype), data=Coral)

##Check residuals
Prot.lme_res <- simulateResiduals(fittedModel = Prot.lme, plot = F)
plot(Prot.lme_res)

##Model results
anova(Prot.lme)

eta_squared(Prot.lme)

##Save model results
Prot.res<-data.frame(anova(Prot.lme))
Prot.res$Predictor<-c("Origin", "Site", "Time", "Origin x Site", "Origin x Time", "Site x Time", "Origin x Site x Time")
Prot.res$EtaSq<-c(eta_squared(Prot.lme)$Eta2)
Prot.res$Response<-rep("Protein", nrow(Prot.res))

##Pairwise Comparisons of Interest
#Native vs Transplant within a Site and Timepoint
Prot.pair<-emmeans(Prot.lme, pairwise~Origin | Site*TimeP)

eff_size(Prot.pair, sigma=sigma(Prot.lme), edf=df.residual(Prot.lme))

```


#### Biomass
```{r}
##Check normality
hist(Coral$AFDW_mg.cm2)
shapiro.test(Coral$AFDW_mg.cm2)
#Normal

##Model 
#Function of Site and Origin and Time, with Genotype as a Random effect
#All Interactions included
Bio.lme<-lmer(AFDW_mg.cm2~Origin*Site*TimeP+(1|Genotype), data=Coral)

##Check residuals
Bio.lme_res <- simulateResiduals(fittedModel = Bio.lme, plot = F)
plot(Bio.lme_res)

##Model results
anova(Bio.lme)

eta_squared(Bio.lme)

##Save model results
Bio.res<-data.frame(anova(Bio.lme))
Bio.res$Predictor<-c("Origin", "Site", "Time", "Origin x Site", "Origin x Time", "Site x Time", "Origin x Site x Time")
Bio.res$EtaSq<-c(eta_squared(Bio.lme)$Eta2)
Bio.res$Response<-rep("Biomass", nrow(Bio.res))

##Pairwise Comparisons of Interest
#Native vs Transplant within a Site and Timepoint
Bio.pair<-emmeans(Bio.lme, pairwise~Origin | Site*TimeP)

eff_size(Bio.pair, sigma=sigma(Bio.lme), edf=df.residual(Bio.lme))

```


#### Chlorophyll
```{r}
##Check normality
hist(Coral$Chl_ug.cm2)
shapiro.test(Coral$Chl_ug.cm2)
#Not normal

hist(log(Coral$Chl_ug.cm2+1))
shapiro.test(log(Coral$Chl_ug.cm2+1))
#Improved

##Model 
#Function of Site and Origin and Time, with Genotype as a Random effect
#All Interactions included
Chl.lme<-lmer(log(Chl_ug.cm2+1)~Origin*Site*TimeP+(1|Genotype), data=Coral)

##Check residuals
Chl.lme_res <- simulateResiduals(fittedModel = Chl.lme, plot = F)
plot(Chl.lme_res)

##Model results
anova(Chl.lme)

eta_squared(Chl.lme)

##Save model results
Chl.res<-data.frame(anova(Chl.lme))
Chl.res$Predictor<-c("Origin", "Site", "Time", "Origin x Site", "Origin x Time", "Site x Time", "Origin x Site x Time")
Chl.res$EtaSq<-c(eta_squared(Chl.lme)$Eta2)
Chl.res$Response<-rep("Biomass", nrow(Chl.res))

##Pairwise Comparisons of Interest
#Native vs Transplant within a Site and Timepoint
emmeans(Chl.lme, pairwise~Origin | Site*TimeP)
```


### TP1

```{r}
##Subset Timepoint 1 
Coral.TP1<-subset(Coral, TimeP=="TP1")

```


#### Protein
```{r}
##Check normality
hist(Coral.TP1$TP_ug.cm2)
shapiro.test(Coral.TP1$TP_ug.cm2)
#Normal

##Model 
#Function of Site and Origin, with Genotype as a Random effect
#Interactions between Origin and Site
Prot.lme_TP1<-lmer(TP_ug.cm2~Origin*Site+(1|Genotype), data=Coral.TP1)

##Check residuals
Prot.lme_res_TP1 <- simulateResiduals(fittedModel = Prot.lme_TP1, plot = F)
plot(Prot.lme_res_TP1)

##Model results
summary(Prot.lme_TP1)

eta_squared(Prot.lme_TP1)

##Save model results
Prot_TP1.res<-data.frame(summary(Prot.lme_TP1)$coefficients[-1,])
Prot_TP1.res$Predictor<-c("Origin", "Site", "Origin x Site")
Prot_TP1.res$EtaSq<-c(eta_squared(Prot.lme_TP1)$Eta2)
Prot_TP1.res$Response<-rep("Protein", nrow(Prot_TP1.res))
```


Effect size of Origin for each Site
```{r}
##KL
Prot.lme_TP1_KL<-lmer(TP_ug.cm2~Origin+(1|Genotype), data=Coral.TP1[which(Coral.TP1$Site=="KL"),])
summary(Prot.lme_TP1_KL)
eta_squared(Prot.lme_TP1_KL)


##SS
Prot.lme_TP1_SS<-lmer(TP_ug.cm2~Origin+(1|Genotype), data=Coral.TP1[which(Coral.TP1$Site=="SS"),])
summary(Prot.lme_TP1_SS)
eta_squared(Prot.lme_TP1_SS)


##Save results
Prot_TP1.site.res<-data.frame(rbind(summary(Prot.lme_TP1_KL)$coefficients[-1,],
                                      summary(Prot.lme_TP1_SS)$coefficients[-1,]))
Prot_TP1.site.res$Predictor<-c("KL Origin", "SS Origin")
Prot_TP1.site.res$EtaSq<-c(eta_squared(Prot.lme_TP1_KL)$Eta2, eta_squared(Prot.lme_TP1_SS)$Eta2)
Prot_TP1.site.res$Response<-rep("Protein", nrow(Prot_TP1.site.res))

##Combine results 
Prot_TP1.res<-rbind(Prot_TP1.res, Prot_TP1.site.res)

```



```{r Plot Protein TP1}
##Summary statistics by Site and Origin
TP1_Prot.sum<-summarySE(Coral.TP1, measurevar="TP_ug.cm2", groupvars=c("Site", "Origin", "Site.Orig"), na.rm=TRUE)

##Plot Average Protein across Treatments
TP1_Prot.plot<-ggplot(TP1_Prot.sum, aes(x=Site, y=TP_ug.cm2, colour=Site.Orig)) + 
  scale_colour_manual(values=Orig.colors.o)+
  geom_errorbar(aes(ymin=TP_ug.cm2-se, ymax=TP_ug.cm2+se), width=cap.sz, linewidth=bar.sz, position=position_dodge(width=0.5)) +
  geom_point(size=point.sz, position=position_dodge(width=0.5))+
  theme_classic()+
  theme(axis.title.x = element_text(size = axis.title.sz), 
        axis.title.y = element_text(size = axis.title.sz), 
        axis.text.x=element_text(size=axis.txt.sz, colour="black"),
        axis.text.y=element_text(size=axis.txt.sz, colour="black"), 
        legend.text=element_text(size=leg.txt.sz), 
        legend.title=element_text(size=leg.title.sz), 
        legend.box.background = element_rect(color = "black"), 
        legend.position="top")+
  labs(x="Site and Origin", y=expression(paste('Protein (\u03BCg cm'^-2*")")), colour=NULL)+
  ylim(550, 950)+
  annotate("text", x=2, y=950, label="**", size=sig.sz, fontface="bold")+
  geom_bracket(xmin=1, xmax=2, y.position=562, label.size=levels.sz, label="**", inherit.aes = FALSE); TP1_Prot.plot
```


#### Biomass 
```{r}
##Check normality
hist(Coral.TP1$AFDW_mg.cm2)
shapiro.test(Coral.TP1$AFDW_mg.cm2)
#Normal

##Model
#Function of Site and Origin, with Genotype as a Random effect
#Interactions between Origin and Site
Bio.lme_TP1<-lmer(AFDW_mg.cm2~Origin*Site+(1|Genotype), data=Coral.TP1)

##Check residuals
Bio.lme_res_TP1 <- simulateResiduals(fittedModel = Bio.lme_TP1, plot = F)
plot(Bio.lme_res_TP1)

##Model results
summary(Bio.lme_TP1)

eta_squared(Bio.lme_TP1)

##Save model results
Bio_TP1.res<-data.frame(summary(Bio.lme_TP1)$coefficients[-1,])
Bio_TP1.res$Predictor<-c("Origin", "Site", "Origin x Site")
Bio_TP1.res$EtaSq<-c(eta_squared(Bio.lme_TP1)$Eta2)
Bio_TP1.res$Response<-rep("Biomass", nrow(Bio_TP1.res))

```


Effect size of Origin for each Site
```{r}
##KL
Bio.lme_TP1_KL<-lmer(AFDW_mg.cm2~Origin+(1|Genotype), data=Coral.TP1[which(Coral.TP1$Site=="KL"),])
summary(Bio.lme_TP1_KL)
eta_squared(Bio.lme_TP1_KL)

##SS
Bio.lme_TP1_SS<-lmer(AFDW_mg.cm2~Origin+(1|Genotype), data=Coral.TP1[which(Coral.TP1$Site=="SS"),])
summary(Bio.lme_TP1_SS)
eta_squared(Bio.lme_TP1_SS)

##Save results
Bio_TP1.site.res<-data.frame(rbind(summary(Bio.lme_TP1_KL)$coefficients[-1,],
                                      summary(Bio.lme_TP1_SS)$coefficients[-1,]))
Bio_TP1.site.res$Predictor<-c("KL Origin", "SS Origin")
Bio_TP1.site.res$EtaSq<-c(eta_squared(Bio.lme_TP1_KL)$Eta2, eta_squared(Bio.lme_TP1_SS)$Eta2)
Bio_TP1.site.res$Response<-rep("Biomass", nrow(Bio_TP1.site.res))

##Combine results 
Bio_TP1.res<-rbind(Bio_TP1.res, Bio_TP1.site.res)

```


```{r Plot Biomass TP1}
##Summary statistics by Site and Origin
TP1_Bio.sum<-summarySE(Coral.TP1, measurevar="AFDW_mg.cm2", groupvars=c("Site", "Origin", "Site.Orig"), na.rm=TRUE)

##Plot Average Biomass across Treatments
TP1_Bio.plot<-ggplot(TP1_Bio.sum, aes(x=Site, y=AFDW_mg.cm2, colour=Site.Orig)) + 
  scale_colour_manual(values=Orig.colors.o)+
  geom_errorbar(aes(ymin=AFDW_mg.cm2-se, ymax=AFDW_mg.cm2+se), width=cap.sz, linewidth=bar.sz, position=position_dodge(width=0.5)) +
  geom_point(size=point.sz, position=position_dodge(width=0.5))+
  theme_classic()+
  theme(axis.title.x = element_text(size = axis.title.sz),
        axis.title.y = element_text(size = axis.title.sz), 
        axis.text.x=element_text(size=axis.txt.sz, colour="black"),
        axis.text.y=element_text(size=axis.txt.sz, colour="black"), 
        legend.text=element_text(size=leg.txt.sz), 
        legend.title=element_text(size=leg.title.sz), 
        legend.box.background = element_rect(color = "black"), 
        legend.position = "top")+
  labs(x="Site and Origin", y=expression(paste('Biomass (mg cm'^-2*")")), colour=NULL)+
  ylim(1.35, 2.45)+
   annotate("text", x=2, y=2.1, label="*", size=sig.sz, fontface="bold"); TP1_Bio.plot
```


#### Chlorophyll
```{r}
##Check normality
hist(Coral.TP1$Chl_ug.cm2)
shapiro.test(Coral.TP1$Chl_ug.cm2)
#Normal

##Model
#Function of Site and Origin, with Genotype as a Random effect
#Interactions between Origin and Site
Chl.lme_TP1<-lmer(Chl_ug.cm2~Origin*Site+(1|Genotype), data=Coral.TP1)

##Check residuals
Chl.lme_res_TP1 <- simulateResiduals(fittedModel = Chl.lme_TP1, plot = F)
plot(Chl.lme_res_TP1)

##Model results
summary(Chl.lme_TP1)

eta_squared(Chl.lme_TP1)

##Save model results
Chl_TP1.res<-data.frame(summary(Chl.lme_TP1)$coefficients[-1,])
Chl_TP1.res$Predictor<-c("Origin", "Site", "Origin x Site")
Chl_TP1.res$EtaSq<-c(eta_squared(Chl.lme_TP1)$Eta2)
Chl_TP1.res$Response<-rep("Chlorophyll", nrow(Chl_TP1.res))

```


Effect size of Origin for each Site
```{r}
##KL
Chl.lme_TP1_KL<-lmer(Chl_ug.cm2~Origin+(1|Genotype), data=Coral.TP1[which(Coral.TP1$Site=="KL"),])
summary(Chl.lme_TP1_KL)
eta_squared(Chl.lme_TP1_KL)

##SS
Chl.lme_TP1_SS<-lmer(Chl_ug.cm2~Origin+(1|Genotype), data=Coral.TP1[which(Coral.TP1$Site=="SS"),])
summary(Chl.lme_TP1_SS)
eta_squared(Chl.lme_TP1_SS)

##Save results
Chl_TP1.site.res<-data.frame(rbind(summary(Chl.lme_TP1_KL)$coefficients[-1,],
                                     summary(Chl.lme_TP1_SS)$coefficients[-1,]))
Chl_TP1.site.res$Predictor<-c("KL Origin", "SS Origin")
Chl_TP1.site.res$EtaSq<-c(eta_squared(Chl.lme_TP1_KL)$Eta2, eta_squared(Chl.lme_TP1_SS)$Eta2)
Chl_TP1.site.res$Response<-rep("Chlorophyll", nrow(Chl_TP1.site.res))

##Combine results 
Chl_TP1.res<-rbind(Chl_TP1.res, Chl_TP1.site.res)

```


```{r Plot Chlorophyll TP1}
##Summary statistics by Site and Origin
TP1_Chl.sum<-summarySE(Coral.TP1, measurevar="Chl_ug.cm2", groupvars=c("Site", "Origin", "Site.Orig"), na.rm=TRUE)

##Plot Average Chlorophyll across Treatments
TP1_Chl.plot<-ggplot(TP1_Chl.sum, aes(x=Site, y=Chl_ug.cm2, colour=Site.Orig)) + 
  scale_colour_manual(values=Orig.colors.o)+
  geom_errorbar(aes(ymin=Chl_ug.cm2-se, ymax=Chl_ug.cm2+se), width=cap.sz, linewidth=bar.sz, position=position_dodge(width=0.5)) +
  geom_point(size=point.sz, position=position_dodge(width=0.5))+
  theme_classic()+
  theme(axis.title.x = element_text(size = axis.title.sz), 
        axis.title.y = element_text(size = axis.title.sz), 
        axis.text.x=element_text(size=axis.txt.sz, colour="black"),
        axis.text.y=element_text(size=axis.txt.sz, colour="black"), 
        legend.text=element_text(size=leg.txt.sz), 
        legend.title=element_text(size=leg.title.sz), 
        legend.box.background = element_rect(color = "black"), 
        legend.position="top")+
  labs(x="Site and Origin", y=expression(paste('Total Chlorophyll (\u03BCg cm'^-2*")")), colour=NULL)+
  ylim(0.5, 3.25)+
  annotate("text", x=2, y=1.7, label="***", size=sig.sz, fontface="bold")+
  geom_bracket(xmin=1, xmax=2, y.position=0.54, label.size=levels.sz, label="***", inherit.aes = FALSE); TP1_Chl.plot
```


#### Save Results
```{r}
##Combine Results
Phys_T1.res<-rbind(Prot_TP1.res, Bio_TP1.res, Chl_TP1.res)

##Add Timepoint
Phys_T1.res$TimeP<-rep("TP1", nrow(Phys_T1.res))

```


### TP2

```{r}
##Subset Timepoint 2 
Coral.TP2<-subset(Coral, TimeP=="TP2")

```


#### Protein 
```{r}
##Check normality
hist(Coral.TP2$TP_ug.cm2)
shapiro.test(Coral.TP2$TP_ug.cm2)
#Normal

##Model 
#Function of Site and Origin, with Genotype as a Random effect
#Interactions between Origin and Site
Prot.lme_TP2<-lmer(TP_ug.cm2~Origin*Site+(1|Genotype), data=Coral.TP2)

##Check residuals
Prot.lme_res_TP2 <- simulateResiduals(fittedModel = Prot.lme_TP2, plot = F)
plot(Prot.lme_res_TP2)

##Model results
summary(Prot.lme_TP2)

eta_squared(Prot.lme_TP2)

##Save model results
Prot_TP2.res<-data.frame(summary(Prot.lme_TP2)$coefficients[-1,])
Prot_TP2.res$Predictor<-c("Origin", "Site", "Origin x Site")
Prot_TP2.res$EtaSq<-c(eta_squared(Prot.lme_TP2)$Eta2)
Prot_TP2.res$Response<-rep("Protein", nrow(Prot_TP2.res))

```


Effect size of Origin for each Site
```{r}
##KL
Prot.lme_TP2_KL<-lmer(TP_ug.cm2~Origin+(1|Genotype), data=Coral.TP2[which(Coral.TP2$Site=="KL"),])
summary(Prot.lme_TP2_KL)
eta_squared(Prot.lme_TP2_KL)


##SS
Prot.lme_TP2_SS<-lmer(TP_ug.cm2~Origin+(1|Genotype), data=Coral.TP2[which(Coral.TP2$Site=="SS"),])
summary(Prot.lme_TP2_SS)
eta_squared(Prot.lme_TP2_SS)


##Save results
Prot_TP2.site.res<-data.frame(rbind(summary(Prot.lme_TP2_KL)$coefficients[-1,],
                                      summary(Prot.lme_TP2_SS)$coefficients[-1,]))
Prot_TP2.site.res$Predictor<-c("KL Origin", "SS Origin")
Prot_TP2.site.res$EtaSq<-c(eta_squared(Prot.lme_TP2_KL)$Eta2, eta_squared(Prot.lme_TP2_SS)$Eta2)
Prot_TP2.site.res$Response<-rep("Protein", nrow(Prot_TP2.site.res))

##Combine results 
Prot_TP2.res<-rbind(Prot_TP2.res, Prot_TP2.site.res)

```



```{r Plot Protein TP2}
##Summary statistics by Site and Origin
TP2_Prot.sum<-summarySE(Coral.TP2, measurevar="TP_ug.cm2", groupvars=c("Site", "Origin", "Site.Orig"), na.rm=TRUE)

##Plot Average Protein across Treatments
TP2_Prot.plot<-ggplot(TP2_Prot.sum, aes(x=Site, y=TP_ug.cm2, colour=Site.Orig)) + 
  scale_colour_manual(values=Orig.colors.o)+
  geom_errorbar(aes(ymin=TP_ug.cm2-se, ymax=TP_ug.cm2+se), width=cap.sz, linewidth=bar.sz, position=position_dodge(width=0.5)) +
  geom_point(size=point.sz, position=position_dodge(width=0.5))+
  theme_classic()+
  theme(axis.title.x = element_text(size = axis.title.sz), 
        axis.title.y = element_text(size = axis.title.sz), 
        axis.text.x=element_text(size=axis.txt.sz, colour="black"),
        axis.text.y=element_text(size=axis.txt.sz, colour="black"), 
        legend.text=element_text(size=leg.txt.sz), 
        legend.title=element_text(size=leg.title.sz), 
        legend.box.background = element_rect(color = "black"), 
        legend.position="top")+
  labs(x="Site and Origin", y=expression(paste('Protein (\u03BCg cm'^-2*")")), colour=NULL)+
  ylim(550, 950)+
  geom_bracket(xmin=1, xmax=2, y.position=562, label.size=levels.sz, label="*", inherit.aes = FALSE); TP2_Prot.plot
```


#### Biomass 
```{r}
##Check normality
hist(Coral.TP2$AFDW_mg.cm2)
shapiro.test(Coral.TP2$AFDW_mg.cm2)
#Normal

##Model
#Function of Site and Origin, with Genotype as a Random effect
#Interactions between Origin and Site
Bio.lme_TP2<-lmer(AFDW_mg.cm2~Origin*Site+(1|Genotype), data=Coral.TP2)

##Check residuals
Bio.lme_res_TP2 <- simulateResiduals(fittedModel = Bio.lme_TP2, plot = F)
plot(Bio.lme_res_TP2)

##Model results
summary(Bio.lme_TP2)

eta_squared(Bio.lme_TP2)

##Save model results
Bio_TP2.res<-data.frame(summary(Bio.lme_TP2)$coefficients[-1,])
Bio_TP2.res$Predictor<-c("Origin", "Site", "Origin x Site")
Bio_TP2.res$EtaSq<-c(eta_squared(Bio.lme_TP2)$Eta2)
Bio_TP2.res$Response<-rep("Biomass", nrow(Bio_TP2.res))

```


Effect size of Origin for each Site
```{r}
##KL
Bio.lme_TP2_KL<-lmer(AFDW_mg.cm2~Origin+(1|Genotype), data=Coral.TP2[which(Coral.TP2$Site=="KL"),])
summary(Bio.lme_TP2_KL)
eta_squared(Bio.lme_TP2_KL)

##SS
Bio.lme_TP2_SS<-lmer(AFDW_mg.cm2~Origin+(1|Genotype), data=Coral.TP2[which(Coral.TP2$Site=="SS"),])
summary(Bio.lme_TP2_SS)
eta_squared(Bio.lme_TP2_SS)

##Save results
Bio_TP2.site.res<-data.frame(rbind(summary(Bio.lme_TP2_KL)$coefficients[-1,],
                                     summary(Bio.lme_TP2_SS)$coefficients[-1,]))
Bio_TP2.site.res$Predictor<-c("KL Origin", "SS Origin")
Bio_TP2.site.res$EtaSq<-c(eta_squared(Bio.lme_TP2_KL)$Eta2, eta_squared(Bio.lme_TP2_SS)$Eta2)
Bio_TP2.site.res$Response<-rep("Biomass", nrow(Bio_TP2.site.res))

##Combine results 
Bio_TP2.res<-rbind(Bio_TP2.res, Bio_TP2.site.res)

```


```{r Plot Biomass TP2}
##Summary statistics by Site and Origin
TP2_Bio.sum<-summarySE(Coral.TP2, measurevar="AFDW_mg.cm2", groupvars=c("Site", "Origin", "Site.Orig"), na.rm=TRUE)

##Plot Average Biomass across Treatments
TP2_Bio.plot<-ggplot(TP2_Bio.sum, aes(x=Site, y=AFDW_mg.cm2, colour=Site.Orig)) + 
  scale_colour_manual(values=Orig.colors.o)+
  geom_errorbar(aes(ymin=AFDW_mg.cm2-se, ymax=AFDW_mg.cm2+se), width=cap.sz, linewidth=bar.sz, position=position_dodge(width=0.5)) +
  geom_point(size=point.sz, position=position_dodge(width=0.5))+
  theme_classic()+
  theme(axis.title.x = element_text(size = axis.title.sz), 
        axis.title.y = element_text(size = axis.title.sz), 
        axis.text.x=element_text(size=axis.txt.sz, colour="black"),
        axis.text.y=element_text(size=axis.txt.sz, colour="black"), 
        legend.text=element_text(size=leg.txt.sz), 
        legend.title=element_text(size=leg.title.sz), 
        legend.box.background = element_rect(color = "black"), 
        legend.position="top")+
  labs(x="Site and Origin", y=expression(paste('Biomass (mg cm'^-2*")")), colour=NULL)+
  ylim(1.35, 2.45)+
  annotate("text", x=1, y=2, label="*", size=levels.sz, fontface="bold"); TP2_Bio.plot
```


#### Chlorophyll
```{r}
##Check normality
hist(Coral.TP2$Chl_ug.cm2)
shapiro.test(Coral.TP2$Chl_ug.cm2)
#Normal

##Model
#Function of Site and Origin, with Genotype as a Random effect
#Interactions between Origin and Site
Chl.lme_TP2<-lmer(Chl_ug.cm2~Origin*Site+(1|Genotype), data=Coral.TP2)

##Check residuals
Chl.lme_res_TP2 <- simulateResiduals(fittedModel = Chl.lme_TP2, plot = F)
plot(Chl.lme_res_TP2)

##Model results
summary(Chl.lme_TP2)

eta_squared(Chl.lme_TP2)

##Save model results
Chl_TP2.res<-data.frame(summary(Chl.lme_TP2)$coefficients[-1,])
Chl_TP2.res$Predictor<-c("Origin", "Site", "Origin x Site")
Chl_TP2.res$EtaSq<-c(eta_squared(Chl.lme_TP2)$Eta2)
Chl_TP2.res$Response<-rep("Chlorophyll", nrow(Chl_TP2.res))

```


Effect size of Origin for each Site
```{r}
##KL
Chl.lme_TP2_KL<-lmer(Chl_ug.cm2~Origin+(1|Genotype), data=Coral.TP2[which(Coral.TP2$Site=="KL"),])
summary(Chl.lme_TP2_KL)
eta_squared(Chl.lme_TP2_KL)


##SS
Chl.lme_TP2_SS<-lmer(Chl_ug.cm2~Origin+(1|Genotype), data=Coral.TP2[which(Coral.TP2$Site=="SS"),])
summary(Chl.lme_TP2_SS)
eta_squared(Chl.lme_TP2_SS)


##Save results
Chl_TP2.site.res<-data.frame(rbind(summary(Chl.lme_TP2_KL)$coefficients[-1,],
                                     summary(Chl.lme_TP2_SS)$coefficients[-1,]))
Chl_TP2.site.res$Predictor<-c("KL Origin", "SS Origin")
Chl_TP2.site.res$EtaSq<-c(eta_squared(Chl.lme_TP2_KL)$Eta2, eta_squared(Chl.lme_TP2_SS)$Eta2)
Chl_TP2.site.res$Response<-rep("Chlorophyll", nrow(Chl_TP2.site.res))

##Combine results 
Chl_TP2.res<-rbind(Chl_TP2.res, Chl_TP2.site.res)

```


```{r Plot Chlorophyll TP2}
##Summary statistics by Site and Origin
TP2_Chl.sum<-summarySE(Coral.TP2, measurevar="Chl_ug.cm2", groupvars=c("Site", "Origin", "Site.Orig"), na.rm=TRUE)

##Plot Average Chlorophyll across Treatments
TP2_Chl.plot<-ggplot(TP2_Chl.sum, aes(x=Site, y=Chl_ug.cm2, colour=Site.Orig)) + 
  scale_colour_manual(values=Orig.colors.o)+
  geom_errorbar(aes(ymin=Chl_ug.cm2-se, ymax=Chl_ug.cm2+se), width=cap.sz, linewidth=bar.sz, position=position_dodge(width=0.5)) +
  geom_point(size=point.sz, position=position_dodge(width=0.5))+
  theme_classic()+
  theme(axis.title.x = element_text(size = axis.title.sz), 
        axis.title.y = element_text(size = axis.title.sz), 
        axis.text.x=element_text(size=axis.txt.sz, colour="black"),
        axis.text.y=element_text(size=axis.txt.sz, colour="black"), 
        legend.text=element_text(size=leg.txt.sz), 
        legend.title=element_text(size=leg.title.sz), 
        legend.box.background = element_rect(color = "black"), 
        legend.position= "top")+
  labs(x="Site and Origin", y=expression(paste('Total Chlorophyll (\u03BCg cm'^-2*")")), colour=NULL)+
  ylim(0.5, 3.25)+
  annotate("text", x=c(1,2), y=c(1.5, 2.6), label="*", size=sig.sz, fontface="bold")+
  geom_bracket(xmin=1, xmax=2, y.position=0.54, label.size=levels.sz, label="**", inherit.aes = FALSE); TP2_Chl.plot
```


#### Save Results
```{r}
##Combine Results
Phys_T2.res<-rbind(Prot_TP2.res, Bio_TP2.res, Chl_TP2.res)

##Add Timepoint
Phys_T2.res$TimeP<-rep("TP2", nrow(Phys_T2.res))

```


### TP3

```{r}
##Subset Timepoint 3 
Coral.TP3<-subset(Coral, TimeP=="TP3")

```


#### Protein 
```{r}
##Check normality
hist(Coral.TP3$TP_ug.cm2)
shapiro.test(Coral.TP3$TP_ug.cm2)
#Normal

##Model 
#Function of Site and Origin, with Genotype as a Random effect
#Interactions between Origin and Site
Prot.lme_TP3<-lmer(TP_ug.cm2~Origin*Site+(1|Genotype), data=Coral.TP3)

##Check residuals
Prot.lme_res_TP3 <- simulateResiduals(fittedModel = Prot.lme_TP3, plot = F)
plot(Prot.lme_res_TP3)

##Model results
summary(Prot.lme_TP3)

eta_squared(Prot.lme_TP3)

##Save model results
Prot_TP3.res<-data.frame(summary(Prot.lme_TP3)$coefficients[-1,])
Prot_TP3.res$Predictor<-c("Origin", "Site", "Origin x Site")
Prot_TP3.res$EtaSq<-c(eta_squared(Prot.lme_TP3)$Eta2)
Prot_TP3.res$Response<-rep("Protein", nrow(Prot_TP3.res))

```


Effect size of Origin for each Site
```{r}
##KL
Prot.lme_TP3_KL<-lmer(TP_ug.cm2~Origin+(1|Genotype), data=Coral.TP3[which(Coral.TP3$Site=="KL"),])
summary(Prot.lme_TP3_KL)
eta_squared(Prot.lme_TP3_KL)


##SS
Prot.lme_TP3_SS<-lmer(TP_ug.cm2~Origin+(1|Genotype), data=Coral.TP3[which(Coral.TP3$Site=="SS"),])
summary(Prot.lme_TP3_SS)
eta_squared(Prot.lme_TP3_SS)


##Save results
Prot_TP3.site.res<-data.frame(rbind(summary(Prot.lme_TP3_KL)$coefficients[-1,],
                                      summary(Prot.lme_TP3_SS)$coefficients[-1,]))
Prot_TP3.site.res$Predictor<-c("KL Origin", "SS Origin")
Prot_TP3.site.res$EtaSq<-c(eta_squared(Prot.lme_TP3_KL)$Eta2, eta_squared(Prot.lme_TP3_SS)$Eta2)
Prot_TP3.site.res$Response<-rep("Protein", nrow(Prot_TP3.site.res))

##Combine results 
Prot_TP3.res<-rbind(Prot_TP3.res, Prot_TP3.site.res)

```



```{r Plot Protein TP3}
##Summary statistics by Site and Origin
TP3_Prot.sum<-summarySE(Coral.TP3, measurevar="TP_ug.cm2", groupvars=c("Site", "Origin", "Site.Orig"), na.rm=TRUE)

##Plot Average Protein across Treatments
TP3_Prot.plot<-ggplot(TP3_Prot.sum, aes(x=Site, y=TP_ug.cm2, colour=Site.Orig)) + 
  scale_colour_manual(values=Orig.colors.o)+
  geom_errorbar(aes(ymin=TP_ug.cm2-se, ymax=TP_ug.cm2+se), width=cap.sz, linewidth=bar.sz, position=position_dodge(width=0.5)) +
  geom_point(size=point.sz, position=position_dodge(width=0.5))+
  theme_classic()+
  theme(axis.title.x = element_text(size = axis.title.sz), 
        axis.title.y = element_text(size = axis.title.sz), 
        axis.text.x=element_text(size=axis.txt.sz, colour="black"),
        axis.text.y=element_text(size=axis.txt.sz, colour="black"), 
        legend.text=element_text(size=leg.txt.sz), 
        legend.title=element_text(size=leg.title.sz), 
        legend.box.background = element_rect(color = "black"), 
        legend.position="top")+
  labs(x="Site and Origin", y=expression(paste('Protein (\u03BCg cm'^-2*")")), colour=NULL)+
  ylim(550, 950); TP3_Prot.plot
```


#### Biomass 
```{r}
##Check normality
hist(Coral.TP3$AFDW_mg.cm2)
shapiro.test(Coral.TP3$AFDW_mg.cm2)
#Normal

##Model
#Function of Site and Origin, with Genotype as a Random effect
#Interactions between Origin and Site
Bio.lme_TP3<-lmer(AFDW_mg.cm2~Origin*Site+(1|Genotype), data=Coral.TP3)

##Check residuals
Bio.lme_res_TP3 <- simulateResiduals(fittedModel = Bio.lme_TP3, plot = F)
plot(Bio.lme_res_TP3)

##Model results
summary(Bio.lme_TP3)

eta_squared(Bio.lme_TP3)

##Save model results
Bio_TP3.res<-data.frame(summary(Bio.lme_TP3)$coefficients[-1,])
Bio_TP3.res$Predictor<-c("Origin", "Site", "Origin x Site")
Bio_TP3.res$EtaSq<-c(eta_squared(Bio.lme_TP3)$Eta2)
Bio_TP3.res$Response<-rep("Biomass", nrow(Bio_TP3.res))

```


Effect size of Origin for each Site
```{r}
##KL
Bio.lme_TP3_KL<-lmer(AFDW_mg.cm2~Origin+(1|Genotype), data=Coral.TP3[which(Coral.TP3$Site=="KL"),])
summary(Bio.lme_TP3_KL)
eta_squared(Bio.lme_TP3_KL)

##SS
Bio.lme_TP3_SS<-lmer(AFDW_mg.cm2~Origin+(1|Genotype), data=Coral.TP3[which(Coral.TP3$Site=="SS"),])
summary(Bio.lme_TP3_SS)
eta_squared(Bio.lme_TP3_SS)

##Save results
Bio_TP3.site.res<-data.frame(rbind(summary(Bio.lme_TP3_KL)$coefficients[-1,],
                                     summary(Bio.lme_TP3_SS)$coefficients[-1,]))
Bio_TP3.site.res$Predictor<-c("KL Origin", "SS Origin")
Bio_TP3.site.res$EtaSq<-c(eta_squared(Bio.lme_TP3_KL)$Eta2, eta_squared(Bio.lme_TP3_SS)$Eta2)
Bio_TP3.site.res$Response<-rep("Biomass", nrow(Bio_TP3.site.res))

##Combine results 
Bio_TP3.res<-rbind(Bio_TP3.res, Bio_TP3.site.res)

```


```{r Plot Biomass TP3}
##Summary statistics by Site and Origin
TP3_Bio.sum<-summarySE(Coral.TP3, measurevar="AFDW_mg.cm2", groupvars=c("Site", "Origin", "Site.Orig"), na.rm=TRUE)

##Plot Average Biomass across Treatments
TP3_Bio.plot<-ggplot(TP3_Bio.sum, aes(x=Site, y=AFDW_mg.cm2, colour=Site.Orig)) + 
  scale_colour_manual(values=Orig.colors.o)+
  geom_errorbar(aes(ymin=AFDW_mg.cm2-se, ymax=AFDW_mg.cm2+se), width=cap.sz, linewidth=bar.sz, position=position_dodge(width=0.5)) +
  geom_point(size=point.sz, position=position_dodge(width=0.5))+
  theme_classic()+
  theme(axis.title.x = element_text(size = axis.title.sz), 
        axis.title.y = element_text(size = axis.title.sz), 
        axis.text.x=element_text(size=axis.txt.sz, colour="black"),
        axis.text.y=element_text(size=axis.txt.sz, colour="black"), 
        legend.text=element_text(size=leg.txt.sz), 
        legend.title=element_text(size=leg.title.sz), 
        legend.box.background = element_rect(color = "black"), 
        legend.position="top")+
  labs(x="Site and Origin", y=expression(paste('Biomass (mg cm'^-2*")")), colour=NULL)+
  ylim(1.35, 2.45); TP3_Bio.plot
```


#### Chlorophyll
```{r}
##Check normality
hist(Coral.TP3$Chl_ug.cm2)
shapiro.test(Coral.TP3$Chl_ug.cm2)
#Not normal

hist(log(Coral.TP3$Chl_ug.cm2+1))
shapiro.test(log(Coral.TP3$Chl_ug.cm2+1))
#Normal

##Model
#Function of Site and Origin, with Genotype as a Random effect
#Interactions between Origin and Site
Chl.lme_TP3<-lmer(log(Chl_ug.cm2+1)~Origin*Site+(1|Genotype), data=Coral.TP3)

##Check residuals
Chl.lme_res_TP3 <- simulateResiduals(fittedModel = Chl.lme_TP3, plot = F)
plot(Chl.lme_res_TP3)

##Model results
summary(Chl.lme_TP3)

eta_squared(Chl.lme_TP3)

##Save model results
Chl_TP3.res<-data.frame(summary(Chl.lme_TP3)$coefficients[-1,])
Chl_TP3.res$Predictor<-c("Origin", "Site", "Origin x Site")
Chl_TP3.res$EtaSq<-c(eta_squared(Chl.lme_TP3)$Eta2)
Chl_TP3.res$Response<-rep("Chlorophyll", nrow(Chl_TP3.res))

```


Effect size of Origin for each Site
```{r}
##KL
Chl.lme_TP3_KL<-lmer(log(Chl_ug.cm2+1)~Origin+(1|Genotype), data=Coral.TP3[which(Coral.TP3$Site=="KL"),])
summary(Chl.lme_TP3_KL)
eta_squared(Chl.lme_TP3_KL)


##SS
Chl.lme_TP3_SS<-lmer(log(Chl_ug.cm2+1)~Origin+(1|Genotype), data=Coral.TP3[which(Coral.TP3$Site=="SS"),])
summary(Chl.lme_TP3_SS)
eta_squared(Chl.lme_TP3_SS)

##Save results
Chl_TP3.site.res<-data.frame(rbind(summary(Chl.lme_TP3_KL)$coefficients[-1,],
                                     summary(Chl.lme_TP3_SS)$coefficients[-1,]))
Chl_TP3.site.res$Predictor<-c("KL Origin", "SS Origin")
Chl_TP3.site.res$EtaSq<-c(eta_squared(Chl.lme_TP3_KL)$Eta2, eta_squared(Chl.lme_TP3_SS)$Eta2)
Chl_TP3.site.res$Response<-rep("Chlorophyll", nrow(Chl_TP3.site.res))

##Combine results 
Chl_TP3.res<-rbind(Chl_TP3.res, Chl_TP3.site.res)

```


```{r Plot Chlorophyll TP3}
##Summary statistics by Site and Origin
TP3_Chl.sum<-summarySE(Coral.TP3, measurevar="Chl_ug.cm2", groupvars=c("Site", "Origin", "Site.Orig"), na.rm=TRUE)

##Plot Average Chlorophyll across Treatments
TP3_Chl.plot<-ggplot(TP3_Chl.sum, aes(x=Site, y=Chl_ug.cm2, colour=Site.Orig)) + 
  scale_colour_manual(values=Orig.colors.o)+
  geom_errorbar(aes(ymin=Chl_ug.cm2-se, ymax=Chl_ug.cm2+se), width=cap.sz, linewidth=bar.sz, position=position_dodge(width=0.5)) +
  geom_point(size=point.sz, position=position_dodge(width=0.5))+
  theme_classic()+
  theme(axis.title.x = element_text(size = axis.title.sz), 
        axis.title.y = element_text(size = axis.title.sz), 
        axis.text.x=element_text(size=axis.txt.sz, colour="black"),
        axis.text.y=element_text(size=axis.txt.sz, colour="black"), 
        legend.text=element_text(size=leg.txt.sz), 
        legend.title=element_text(size=leg.title.sz), 
        legend.box.background = element_rect(color = "black"), 
        legend.position="top")+
  labs(x="Site and Origin", y=expression(paste('Total Chlorophyll (\u03BCg cm'^-2*")")), colour=NULL)+
  ylim(0.5, 3.25)+
  annotate("text", x=1, y=1.5, label="-", size=levels.sz, fontface="bold")+
  geom_bracket(xmin=1, xmax=2, y.position=0.54, label.size=levels.sz, label="**", inherit.aes = FALSE); TP3_Chl.plot
```


#### Save Results
```{r}
##Combine Results
Phys_T3.res<-rbind(Prot_TP3.res, Bio_TP3.res, Chl_TP3.res)

##Add Timepoint
Phys_T3.res$TimeP<-rep("TP3", nrow(Phys_T3.res))

```


### TP4

```{r}
##Subset Timepoint 4 
Coral.TP4<-subset(Coral, TimeP=="TP4")

```


#### Protein 
```{r}
##Check normality
hist(Coral.TP4$TP_ug.cm2)
shapiro.test(Coral.TP4$TP_ug.cm2)
#Normal

##Model 
#Function of Site and Origin, with Genotype as a Random effect
#Interactions between Origin and Site
Prot.lme_TP4<-lmer(TP_ug.cm2~Origin*Site+(1|Genotype), data=Coral.TP4)

##Check residuals
Prot.lme_res_TP4 <- simulateResiduals(fittedModel = Prot.lme_TP4, plot = F)
plot(Prot.lme_res_TP4)

##Model results
summary(Prot.lme_TP4)

eta_squared(Prot.lme_TP4)

##Save model results
Prot_TP4.res<-data.frame(summary(Prot.lme_TP4)$coefficients[-1,])
Prot_TP4.res$Predictor<-c("Origin", "Site", "Origin x Site")
Prot_TP4.res$EtaSq<-c(eta_squared(Prot.lme_TP4)$Eta2)
Prot_TP4.res$Response<-rep("Protein", nrow(Prot_TP4.res))

```


Effect size of Origin for each Site
```{r}
##KL
Prot.lme_TP4_KL<-lmer(TP_ug.cm2~Origin+(1|Genotype), data=Coral.TP4[which(Coral.TP4$Site=="KL"),])
summary(Prot.lme_TP4_KL)
eta_squared(Prot.lme_TP4_KL)


##SS
Prot.lme_TP4_SS<-lmer(TP_ug.cm2~Origin+(1|Genotype), data=Coral.TP4[which(Coral.TP4$Site=="SS"),])
summary(Prot.lme_TP4_SS)
eta_squared(Prot.lme_TP4_SS)


##Save results
Prot_TP4.site.res<-data.frame(rbind(summary(Prot.lme_TP4_KL)$coefficients[-1,],
                                      summary(Prot.lme_TP4_SS)$coefficients[-1,]))
Prot_TP4.site.res$Predictor<-c("KL Origin", "SS Origin")
Prot_TP4.site.res$EtaSq<-c(eta_squared(Prot.lme_TP4_KL)$Eta2, eta_squared(Prot.lme_TP4_SS)$Eta2)
Prot_TP4.site.res$Response<-rep("Protein", nrow(Prot_TP4.site.res))

##Combine results 
Prot_TP4.res<-rbind(Prot_TP4.res, Prot_TP4.site.res)

```



```{r Plot Protein TP4}
##Summary statistics by Site and Origin
TP4_Prot.sum<-summarySE(Coral.TP4, measurevar="TP_ug.cm2", groupvars=c("Site", "Origin", "Site.Orig"), na.rm=TRUE)

##Plot Average Protein across Treatments
TP4_Prot.plot<-ggplot(TP4_Prot.sum, aes(x=Site, y=TP_ug.cm2, colour=Site.Orig)) + 
  scale_colour_manual(values=Orig.colors.o)+
  geom_errorbar(aes(ymin=TP_ug.cm2-se, ymax=TP_ug.cm2+se), width=cap.sz, linewidth=bar.sz, position=position_dodge(width=0.5)) +
  geom_point(size=point.sz, position=position_dodge(width=0.5))+
  theme_classic()+
  theme(axis.title.x = element_text(size = axis.title.sz), 
        axis.title.y = element_text(size = axis.title.sz), 
        axis.text.x=element_text(size=axis.txt.sz, colour="black"),
        axis.text.y=element_text(size=axis.txt.sz, colour="black"), 
        legend.text=element_text(size=leg.txt.sz), 
        legend.title=element_text(size=leg.title.sz), 
        legend.box.background = element_rect(color = "black"), 
        legend.position="top")+
  labs(x="Site and Origin", y=expression(paste('Protein (\u03BCg cm'^-2*")")), colour=NULL)+
  ylim(550, 950)+
  geom_bracket(xmin=1, xmax=2, y.position=562, label.size=levels.sz, label="**", inherit.aes = FALSE); TP4_Prot.plot
```


#### Biomass 
```{r}
##Check normality
hist(Coral.TP4$AFDW_mg.cm2)
shapiro.test(Coral.TP4$AFDW_mg.cm2)
#Normal

##Model
#Function of Site and Origin, with Genotype as a Random effect
#Interactions between Origin and Site
Bio.lme_TP4<-lmer(AFDW_mg.cm2~Origin*Site+(1|Genotype), data=Coral.TP4)

##Check residuals
Bio.lme_res_TP4 <- simulateResiduals(fittedModel = Bio.lme_TP4, plot = F)
plot(Bio.lme_res_TP4)

##Model results
summary(Bio.lme_TP4)

eta_squared(Bio.lme_TP4)

##Save model results
Bio_TP4.res<-data.frame(summary(Bio.lme_TP4)$coefficients[-1,])
Bio_TP4.res$Predictor<-c("Origin", "Site", "Origin x Site")
Bio_TP4.res$EtaSq<-c(eta_squared(Bio.lme_TP4)$Eta2)
Bio_TP4.res$Response<-rep("Biomass", nrow(Bio_TP4.res))

```


Effect size of Origin for each Site
```{r}

##KL
Bio.lme_TP4_KL<-lmer(AFDW_mg.cm2~Origin+(1|Genotype), data=Coral.TP4[which(Coral.TP4$Site=="KL"),])
summary(Bio.lme_TP4_KL)
eta_squared(Bio.lme_TP4_KL)

##SS
Bio.lme_TP4_SS<-lmer(AFDW_mg.cm2~Origin+(1|Genotype), data=Coral.TP4[which(Coral.TP4$Site=="SS"),])
summary(Bio.lme_TP4_SS)
eta_squared(Bio.lme_TP4_SS)

##Save results
Bio_TP4.site.res<-data.frame(rbind(summary(Bio.lme_TP4_KL)$coefficients[-1,],
                                     summary(Bio.lme_TP4_SS)$coefficients[-1,]))
Bio_TP4.site.res$Predictor<-c("KL Origin", "SS Origin")
Bio_TP4.site.res$EtaSq<-c(eta_squared(Bio.lme_TP4_KL)$Eta2, eta_squared(Bio.lme_TP4_SS)$Eta2)
Bio_TP4.site.res$Response<-rep("Biomass", nrow(Bio_TP4.site.res))

##Combine results 
Bio_TP4.res<-rbind(Bio_TP4.res, Bio_TP4.site.res)

```


```{r Plot Biomass TP4}
##Summary statistics by Site and Origin
TP4_Bio.sum<-summarySE(Coral.TP4, measurevar="AFDW_mg.cm2", groupvars=c("Site", "Origin", "Site.Orig"), na.rm=TRUE)

##Plot Average Biomass across Treatments
TP4_Bio.plot<-ggplot(TP4_Bio.sum, aes(x=Site, y=AFDW_mg.cm2, colour=Site.Orig)) + 
  scale_colour_manual(values=Orig.colors.o)+
  geom_errorbar(aes(ymin=AFDW_mg.cm2-se, ymax=AFDW_mg.cm2+se), width=cap.sz, linewidth=bar.sz, position=position_dodge(width=0.5)) +
  geom_point(size=point.sz, position=position_dodge(width=0.5))+
  theme_classic()+
  theme(axis.title.x = element_text(size = axis.title.sz), 
        axis.title.y = element_text(size = axis.title.sz), 
        axis.text.x=element_text(size=axis.txt.sz, colour="black"),
        axis.text.y=element_text(size=axis.txt.sz, colour="black"), 
        legend.text=element_text(size=leg.txt.sz), 
        legend.title=element_text(size=leg.title.sz), 
        legend.box.background = element_rect(color = "black"), 
        legend.position="top")+
  labs(x="Site and Origin", y=expression(paste('Biomass (mg cm'^-2*")")), colour=NULL)+
  ylim(1.35, 2.45)+
  geom_bracket(xmin=1, xmax=2, y.position=1.38, label.size=levels.sz, label="**", inherit.aes = FALSE); TP4_Bio.plot
```


#### Chlorophyll
```{r}
##Check normality
hist(Coral.TP4$Chl_ug.cm2)
shapiro.test(Coral.TP4$Chl_ug.cm2)
#Slightly non normal

hist(log(Coral.TP4$Chl_ug.cm2+1))
shapiro.test(log(Coral.TP4$Chl_ug.cm2+1))
#Normal

##Model
#Function of Site and Origin, with Genotype as a Random effect
#Interactions between Origin and Site
Chl.lme_TP4<-lmer(log(Chl_ug.cm2+1)~Origin*Site+(1|Genotype), data=Coral.TP4)

##Check residuals
Chl.lme_res_TP4 <- simulateResiduals(fittedModel = Chl.lme_TP4, plot = F)
plot(Chl.lme_res_TP4)

##Model results
summary(Chl.lme_TP4)

eta_squared(Chl.lme_TP4)

##Save model results
Chl_TP4.res<-data.frame(summary(Chl.lme_TP4)$coefficients[-1,])
Chl_TP4.res$Predictor<-c("Origin", "Site", "Origin x Site")
Chl_TP4.res$EtaSq<-c(eta_squared(Chl.lme_TP4)$Eta2)
Chl_TP4.res$Response<-rep("Chlorophyll", nrow(Chl_TP4.res))

```


Effect size of Origin for each Site
```{r}

##KL
Chl.lme_TP4_KL<-lmer(log(Chl_ug.cm2+1)~Origin+(1|Genotype), data=Coral.TP4[which(Coral.TP4$Site=="KL"),])
summary(Chl.lme_TP4_KL)
eta_squared(Chl.lme_TP4_KL)


##SS
Chl.lme_TP4_SS<-lmer(log(Chl_ug.cm2+1)~Origin+(1|Genotype), data=Coral.TP4[which(Coral.TP4$Site=="SS"),])
summary(Chl.lme_TP4_SS)
eta_squared(Chl.lme_TP4_SS)

##Save results
Chl_TP4.site.res<-data.frame(rbind(summary(Chl.lme_TP4_KL)$coefficients[-1,],
                                     summary(Chl.lme_TP4_SS)$coefficients[-1,]))
Chl_TP4.site.res$Predictor<-c("KL Origin", "SS Origin")
Chl_TP4.site.res$EtaSq<-c(eta_squared(Chl.lme_TP4_KL)$Eta2, eta_squared(Chl.lme_TP4_SS)$Eta2)
Chl_TP4.site.res$Response<-rep("Chlorophyll", nrow(Chl_TP4.site.res))

##Combine results 
Chl_TP4.res<-rbind(Chl_TP4.res, Chl_TP4.site.res)

```


```{r Plot Chlorophyll TP4}
##Summary statistics by Site and Origin
TP4_Chl.sum<-summarySE(Coral.TP4, measurevar="Chl_ug.cm2", groupvars=c("Site", "Origin", "Site.Orig"), na.rm=TRUE)

##Plot Average Chlorophyll across Treatments
TP4_Chl.plot<-ggplot(TP4_Chl.sum, aes(x=Site, y=Chl_ug.cm2, colour=Site.Orig)) + 
  scale_colour_manual(values=Orig.colors.o)+
  geom_errorbar(aes(ymin=Chl_ug.cm2-se, ymax=Chl_ug.cm2+se), width=cap.sz, linewidth=bar.sz, position=position_dodge(width=0.5)) +
  geom_point(size=point.sz, position=position_dodge(width=0.5))+
  theme_classic()+
  theme(axis.title.x = element_text(size = axis.title.sz), 
        axis.title.y = element_text(size = axis.title.sz), 
        axis.text.x=element_text(size=axis.txt.sz, colour="black"),
        axis.text.y=element_text(size=axis.txt.sz, colour="black"), 
        legend.text=element_text(size=leg.txt.sz), 
        legend.title=element_text(size=leg.title.sz), 
        legend.box.background = element_rect(color = "black"), 
        legend.position="top")+
  labs(x="Site and Origin", y=expression(paste('Total Chlorophyll (\u03BCg cm'^-2*")")), colour=NULL)+
  ylim(0.5, 3.25)+
  geom_bracket(xmin=1, xmax=2, y.position=0.54, label.size=levels.sz, label="***", inherit.aes = FALSE); TP4_Chl.plot
```


#### Save Results
```{r}
##Combine Results
Phys_T4.res<-rbind(Prot_TP4.res, Bio_TP4.res,  Chl_TP4.res)

##Add Timepoint
Phys_T4.res$TimeP<-rep("TP4", nrow(Phys_T4.res))

```


# Effect Size over Time
```{r}
##Dataframe of effect size results
Phys.ES<-rbind(Phys_T1.res, Phys_T2.res, Phys_T3.res, Phys_T4.res)
Phys.ES<-Phys.ES %>% dplyr::rename(p = Pr...t..)
Phys.ES<-Phys.ES[,c("TimeP", "Predictor", "Response", "EtaSq", "p")]

##Add Metric names
Phys.ES$Metric<-ifelse(Phys.ES$Response== "Protein", "TP_ug.cm2",  ifelse(
    Phys.ES$Response=="Biomass", "AFDW_mg.cm2", ifelse(
        Phys.ES$Response=="Chlorophyll", "Chl_ug.cm2", NA)))

##Add Significance levels
Phys.ES$Sig<-ifelse(Phys.ES$p<0.001, "***", ifelse(Phys.ES$p<0.01, "**", 
            ifelse(Phys.ES$p<0.05, "*", ifelse(Phys.ES$p<0.1, "-", NA))))

##Save Dataframe
write.csv(Phys.ES, "Outputs/PhysiologyES.csv", row.names=FALSE)

```


### Site vs Origin
```{r}
##Site specific results
Phys.ES_SO<-Phys.ES[-c(which(Phys.ES$Predictor=="KL Origin" | Phys.ES$Predictor=="SS Origin")),]

```


```{r}
Phys.ES.plot<-ggplot(Phys.ES_SO, aes(fill=Predictor, y=EtaSq, x=TimeP)) + 
    geom_bar(position="stack", stat="identity")+
  facet_wrap(vars(Response))+
  theme_bw()+
  theme(strip.text=element_text(size=axis.title.sz),
        strip.background = element_rect(fill="white"),
        axis.title.x = element_text(size = axis.title.sz), 
        axis.title.y = element_text(size = axis.title.sz), 
        axis.text.x=element_text(size=axis.txt.sz, colour="black"),
        axis.text.y=element_text(size=axis.txt.sz, colour="black"),
        legend.text=element_text(size=leg.txt.sz), 
        legend.title=element_text(size=leg.title.sz), 
        legend.box.background = element_rect(color = "black"), 
        legend.position=c(.15, .8))+
   labs(x="Time Point", y=expression(paste("Effect Size (p", eta^2, ")")), colour="Predictor")+
   geom_text(aes(label=Sig), position=position_stack(vjust=0.5), size=sig.sz); Phys.ES.plot
```


```{r}
Phys.ES.plot_threshold<-ggplot(Phys.ES_SO, aes(fill=Predictor, y=EtaSq, x=TimeP)) + 
  geom_hline(yintercept=0.01, linetype="dashed", color="grey60", linewidth=0.75)+
  geom_hline(yintercept=0.06, linetype="solid", color="grey40", linewidth=0.75)+
  geom_hline(yintercept=0.14, linetype="dashed", color="grey20", linewidth=0.75)+
    geom_bar(position="dodge", stat="identity")+
  facet_wrap(vars(Response))+
  theme_bw()+
  theme(strip.text=element_text(size=axis.title.sz),
        strip.background = element_rect(fill="white"),
        axis.title.x = element_text(size = axis.title.sz), 
        axis.title.y = element_text(size = axis.title.sz), 
        axis.text.x=element_text(size=axis.txt.sz, colour="black"),
        axis.text.y=element_text(size=axis.txt.sz, colour="black"),
        legend.text=element_text(size=leg.txt.sz), 
        legend.title=element_text(size=leg.title.sz), 
        legend.box.background = element_rect(color = "black"), 
        legend.position=c(.15, .8))+
   labs(x="Time Point", y=expression(paste("Effect Size (p", eta^2, ")")), colour="Predictor")+
   geom_text(aes(label=Sig, hjust=0.5), position=position_dodge(width=1), size=sig.sz); Phys.ES.plot_threshold
```


### Site-Specific 
```{r}
##Site specific results
Phys.ES_Orig<-Phys.ES[which(Phys.ES$Predictor=="KL Origin" | Phys.ES$Predictor=="SS Origin"),]
Phys.ES_Orig<-Phys.ES_Orig %>% separate_wider_delim(cols="Predictor", delim=" ", names=c("Site", "Predictor"), cols_remove = TRUE)

```


#### Biomass
```{r Plot Effect Size Biomass}
Bio.ES.plot<-ggplot(Phys.ES_Orig[which(Phys.ES_Orig$Metric=="AFDW_mg.cm2"),], aes(x=TimeP, y=EtaSq, fill=Site))+
  geom_bar(stat="identity", position=position_dodge())+
    scale_fill_manual(values=Site.colors.o)+
theme_classic()+
  ggtitle("Biomass")+
  theme(plot.title = element_text(colour="black", size=panel.lab.sz, hjust=0.5), 
        axis.title.x = element_text(size = axis.title.sz), 
        axis.title.y = element_text(size = axis.title.sz), 
        axis.text.x=element_text(size=axis.txt.sz, colour="black"),
        axis.text.y=element_text(size=axis.txt.sz, colour="black"),
        legend.text=element_text(size=leg.txt.sz), 
        legend.title=element_text(size=leg.title.sz), 
        legend.box.background = element_rect(color = "black"), 
        legend.position=c(.9, .8))+
   labs(x="Time Point", y=expression(paste("Origin Effect Size (p", eta^2, ")")), colour="Site")+
  ylim(0, 0.6)+
  geom_text(aes(label=Sig), vjust=-0.02, color="black", position=position_dodge(0.9), size=levels.sz, fontface="bold"); Bio.ES.plot

```

#### Protein
```{r Plot Effect Size Protein}
Prot.ES.plot<-ggplot(Phys.ES_Orig[which(Phys.ES_Orig$Metric=="TP_ug.cm2"),], aes(x=TimeP, y=EtaSq, fill=Site))+
  geom_bar(stat="identity", position=position_dodge())+
    scale_fill_manual(values=Site.colors.o)+
theme_classic()+
  ggtitle("Protein")+
  theme(plot.title = element_text(colour="black", size=panel.lab.sz, hjust=0.5), 
        axis.title.x = element_text(size = axis.title.sz), 
        axis.title.y = element_text(size = axis.title.sz), 
        axis.text.x=element_text(size=axis.txt.sz, colour="black"),
        axis.text.y=element_text(size=axis.txt.sz, colour="black"),
        legend.text=element_text(size=leg.txt.sz), 
        legend.title=element_text(size=leg.title.sz), 
        legend.box.background = element_rect(color = "black"), 
        legend.position=c(.9, .8))+
   labs(x="Time Point", y=expression(paste("Origin Effect Size (p", eta^2, ")")), colour="Site")+
  ylim(0, 0.6)+
  geom_text(aes(label=Sig), vjust=-0.02, color="black", position=position_dodge(0.9), size=levels.sz, fontface="bold"); Prot.ES.plot

```


#### Chlorophyll
```{r Plot Effect Size Chlorophyll}
Chl.ES.plot<-ggplot(Phys.ES_Orig[which(Phys.ES_Orig$Metric=="Chl_ug.cm2"),], aes(x=TimeP, y=EtaSq, fill=Site))+
  geom_bar(stat="identity", position=position_dodge())+
    scale_fill_manual(values=Site.colors.o)+
theme_classic()+
  ggtitle("Chlorophyll")+
  theme(plot.title = element_text(colour="black", size=panel.lab.sz, hjust=0.5), 
        axis.title.x = element_text(size = axis.title.sz), 
        axis.title.y = element_text(size = axis.title.sz), 
        axis.text.x=element_text(size=axis.txt.sz, colour="black"),
        axis.text.y=element_text(size=axis.txt.sz, colour="black"),
        legend.text=element_text(size=leg.txt.sz), 
        legend.title=element_text(size=leg.title.sz), 
        legend.box.background = element_rect(color = "black"), 
        legend.position=c(.9, .8))+
   labs(x="Time Point", y=expression(paste("Origin Effect Size (p", eta^2, ")")), colour="Site")+
  ylim(0, 0.6)+
  geom_text(aes(label=Sig), vjust=-0.02, color="black", position=position_dodge(0.9), size=levels.sz, fontface="bold"); Chl.ES.plot

```


# Figures

### Figure 3 Univariate Physiology

#### Adjust for Panel
```{r}
##Biomass
TP1_Bio.plot<-TP1_Bio.plot+ ggtitle("TP1")+ labs(x="")+
  theme(plot.title = element_text(colour="black", size=panel.lab.sz, face="bold", hjust=0.5), 
        legend.position=c(0.5, 0.85), legend.direction="horizontal")+
  guides(color=guide_legend(nrow=2, byrow=FALSE)) 

TP2_Bio.plot<-TP2_Bio.plot+ ggtitle("TP2")+ labs(x="", y="") +
  theme(plot.title = element_text(colour="black", size=panel.lab.sz, face="bold", hjust=0.5), 
        legend.position="none")

TP3_Bio.plot<-TP3_Bio.plot+ ggtitle("TP3")+ labs(x="", y="") +
  theme(plot.title = element_text(colour="black", size=panel.lab.sz, face="bold", hjust=0.5), 
        legend.position="none")

TP4_Bio.plot<-TP4_Bio.plot+ ggtitle("TP4")+ labs(x="", y="") +
  theme(plot.title = element_text(colour="black", size=panel.lab.sz, face="bold", hjust=0.5), 
        legend.position="none")

Bio.ES.plot<-Bio.ES.plot + labs(x="") + theme(legend.position=c(.15, .8))

##Protein
TP1_Prot.plot<-TP1_Prot.plot + labs(x="") + theme(legend.position="none")

TP2_Prot.plot<-TP2_Prot.plot + labs(x="", y="") + theme(legend.position="none")

TP3_Prot.plot<-TP3_Prot.plot + labs(x="", y="") + theme(legend.position="none")

TP4_Prot.plot<-TP4_Prot.plot + labs(x="", y="") + theme(legend.position="none")

Prot.ES.plot<-Prot.ES.plot + labs(x="") + theme(legend.position="none") 

##Chlorophyll
TP1_Chl.plot<-TP1_Chl.plot + theme(legend.position="none")

TP2_Chl.plot<-TP2_Chl.plot + labs(y="") + theme(legend.position="none")

TP3_Chl.plot<-TP3_Chl.plot + labs(y="") + theme(legend.position="none")

TP4_Chl.plot<-TP4_Chl.plot + labs(y="") + theme(legend.position="none")

Chl.ES.plot<-Chl.ES.plot + theme(legend.position="none")
```


#### Figure 3
```{r}
##Create Panel
Phys_fig<-plot_grid(TP1_Bio.plot, TP2_Bio.plot, 
                      TP3_Bio.plot, TP4_Bio.plot, Bio.ES.plot, 
                      TP1_Prot.plot, TP2_Prot.plot, 
                      TP3_Prot.plot, TP4_Prot.plot, Prot.ES.plot, 
                      TP1_Chl.plot, TP2_Chl.plot, 
                      TP3_Chl.plot, TP4_Chl.plot, Chl.ES.plot,
                    rel_widths=c(0.8, 0.8, 0.8, 0.8, 1), rel_heights = 1,
                    nrow=3, ncol=5, byrow=T, labels = NULL)

##Save Figure
ggsave(filename="Figures/02_Physiology/Fig3_Physiology.png", plot=Phys_fig, dpi=300, width=16, height=12, units="in")

```


# Tables 

### Table S3A Physiology PERMANOVA and PERMDISP
```{r}
##Combine Results Tables
TableS3A_Phys.PERM<-data.frame(rbind(PERM.res, PERM_T1.res, PERM_T2.res, PERM_T3.res, PERM_T4.res))

##Organize
names(TableS3A_Phys.PERM)
TableS3A_Phys.PERM<-TableS3A_Phys.PERM %>% dplyr::rename( DF = Df, SS = SumOfSqs, EffectSize = parOmegaSq, p = Pr..F.)
TableS3A_Phys.PERM<-TableS3A_Phys.PERM[,c("Timepoint", "Predictor", "DF", "SS", "F",   "EffectSize", "p", "p_DISP")]

#Round to 3 digits
TableS3A_Phys.PERM$SS<-round(TableS3A_Phys.PERM$SS, 3)
TableS3A_Phys.PERM$F<-round(TableS3A_Phys.PERM$F, 3)
TableS3A_Phys.PERM$EffectSize<-round(TableS3A_Phys.PERM$EffectSize, 3)
TableS3A_Phys.PERM$p<-round(TableS3A_Phys.PERM$p, 3)
TableS3A_Phys.PERM$p_DISP<-round(TableS3A_Phys.PERM$p_DISP, 3)

##Write Out Table
write.csv(TableS3A_Phys.PERM, "Tables/TableS3A_Physiology_PERM_Results.csv", row.names=FALSE)


```


### Table S4 Physiology Univariate LM
```{r}
##Combine Results Tables
TableS4_Phys.LM<-data.frame(rbind(Phys_T1.res, Phys_T2.res, Phys_T3.res, Phys_T4.res))

##Organize
names(TableS4_Phys.LM)
TableS4_Phys.LM<-TableS4_Phys.LM %>% dplyr::rename(SE = Std..Error, DF = df, t = t.value, p = Pr...t.., EffectSize = EtaSq, Timepoint = TimeP)
TableS4_Phys.LM<-TableS4_Phys.LM[,c("Timepoint", "Response", "Predictor", "Estimate", "SE", "DF", "t", "p", "EffectSize")]

#Round to 3 digits
TableS4_Phys.LM$Estimate<-round(TableS4_Phys.LM$Estimate, 3)
TableS4_Phys.LM$SE<-round(TableS4_Phys.LM$SE, 3)
TableS4_Phys.LM$t<-round(TableS4_Phys.LM$t, 3)
TableS4_Phys.LM$p<-round(TableS4_Phys.LM$p, 3)
TableS4_Phys.LM$EffectSize<-round(TableS4_Phys.LM$EffectSize, 3)

#Integer
TableS4_Phys.LM$DF<-round(TableS4_Phys.LM$DF, 0)

##Write Out Table
write.csv(TableS4_Phys.LM, "Tables/TableS4_Physiology_LM_Results.csv", row.names=FALSE)

```

