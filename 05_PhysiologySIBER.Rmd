---
title: "SIBER Analysis of Coral Physiology"
author: "Peter Flood and Serena Hackerott"
date: "2/8/2024"
output:
  html_notebook:
    toc: yes
    toc_float: yes
  html_document:
    toc: yes
    df_print: paged
---

# Setup

```{r Setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
getwd()
```


### Load Packages
```{r}
##Install Packages if Needed
if (!require("ggplot2")) install.packages("ggplot2")
if (!require("cowplot")) install.packages("cowplot")
if (!require("SIBER")) install.packages("SIBER")
if (!require("vegan")) install.packages("vegan")
if (!require("Hmisc")) install.packages("Hmisc")
if (!require("corrplot")) install.packages("corrplot")
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("Rmisc")) install.packages("Rmisc")
if (!require("ggpubr")) install.packages("ggpubr")
if (!require("DHARMa")) install.packages("DHARMa")
if (!require("emmeans")) install.packages("emmeans")

##Load Packages
library(ggplot2) #Required for ggplots
library(cowplot) #Required for plotting panel figures
library(SIBER) #Required for generating physiological ellipses and percent overlap calculations
library(vegan) #Required for NMDS
library(Hmisc) #Required for correlations
library(corrplot) #Required for correlation plot
library(tidyverse) #Required for data manipulation
library(Rmisc) #Required for data summary
library(ggpubr) #Required for stat_conf_ellipse
library(DHARMa) #Required to check residuals of mixed effects models
library(emmeans) #Required for pairwise comparisons 


```


# Sample Data and Metadata

### Load and Organize Data
```{r}
##Load Data
#Note: Physiological metrics calculated in 02_PhysiologyMetrics.R file
Phys<-read.csv("Outputs/CoralData.csv", header=TRUE)

##Set factor variables
Phys$TimeP<-factor(Phys$TimeP, levels=c("TP1", "TP2", "TP3", "TP4"))
Phys$Site<-factor(Phys$Site, levels=c("KL", "SS"))
Phys$Genotype<-factor(Phys$Genotype, levels=c("AC8", "AC10", "AC12"))
Phys$Orig<-factor(Phys$Orig, levels=c("N", "T"))
Phys$Origin<-factor(Phys$Origin, levels=c("Native", "Transplant"))
Phys$Site.Orig<-factor(Phys$Site.Orig, levels=c("KL.N", "KL.T", "SS.N", "SS.T"))

##Set rownames
rownames(Phys)<-Phys$ID
```


### Check Correlation
```{r}
##Remove NA's
names(Phys)
Phys.rm<-na.omit(Phys)

##Log +1 transform 
Phys.log<-Phys.rm
Phys.log[,-c(1:10)]<-log(Phys.rm[,-c(1:10)]+1)
  
Phys.corr<-rcorr(as.matrix(Phys.log[,-c(1:10)]), type="pearson")
Phys.corr

diag(Phys.corr$P)<-0

corrplot(Phys.corr$r, type="upper", order="hclust", p.mat = Phys.corr$P, sig.level = 0.01, insig = "blank", tl.col="black")

```
Physiological variables of interest: Protein (Coral and Symbiont), Biomass (Coral and Symbiont), and Chlorophyll.


# SIBER Ellipses

## Prepare Input Data

### NMDS Ordination
SIBER runs on a two dimensional data set. So first, we need to reduce the dimensionality of the physiology data. We're going to do this via Non-Metric Multidimensional Scaling (NMDS) on log+1 transformed physiological metrics of interest.
```{r}
#Select only the physiology columns of interest (without covariates) to put into the NMDS
names(Phys.log)
phys.log.num <- Phys.log[,c(11:14, 16)]

#Run NMDS
phys.nmds <- metaMDS(phys.log.num, distance = "euclidean", k = 2, autotransform = F)

#Quick plot of NMDS output
ordiplot(phys.nmds)
```


### NMDS Model
```{r}
##Correlation with Physiology Metrics
phys.envi.fit <- envfit(phys.nmds, phys.log.num)
phys.envi.fit
phys.envi.vectors <- phys.envi.fit[["vectors"]][["arrows"]]

##Check Stress
stressplot(phys.nmds)
NMDS.stress<- sprintf("Stress = %.2f", phys.nmds$stress)
NMDS.stress

#Calculate Estimated Variance Explained per Axis
# Not a true % variance explained, but an estimate from
# correlating the original distance matrix with the ordination distance
phys.ord.dist <- vegdist(phys.nmds$points[,1:2], method = "euclidean")
phys.distance<-vegdist(phys.log.num, method="euclidean")
plot(phys.distance,phys.ord.dist, xlab = "Original Distance", ylab = "Ordination Distance")
phys.dist.cor<-cor(phys.distance,phys.ord.dist)^2
phys.var.label<-sprintf("Estimated Variance = %.2f", phys.dist.cor*100)
text(1.25, 0.1, phys.var.label)

#Estimate % Variance on Axis 1
phys.ax1_dist<-vegdist(phys.nmds$points[,1],method="euclidean")
NMDS1<-sprintf("%1.2f",(cor(phys.distance,phys.ax1_dist)^2)*100)
NMDS1

#Estimate % Variance on Axis 2
phys.ax2_dist<-vegdist(phys.nmds$points[,2],method="euclidean")
NMDS2<-sprintf("%1.2f",(cor(phys.distance,phys.ax2_dist)^2)*100)
NMDS2

#Prepare for Plotting
phys.nmds.samples.plot.data <- cbind(phys.log.num, phys.nmds$points) 
phys.nmds.samples.plot.data$ID<-rownames(phys.nmds.samples.plot.data)
phys.nmds.samples.plot.data<-merge(phys.nmds.samples.plot.data, Phys.rm[,c(1,3:9)])
phys.nmds.samples.plot.data$Geno.Orig<-paste(phys.nmds.samples.plot.data$Genotype, phys.nmds.samples.plot.data$Orig, sep=".")
phys.nmds.samples.plot.data$Geno.Orig<-factor(phys.nmds.samples.plot.data$Geno.Orig, levels=c("AC8.N","AC8.T", "AC10.N", "AC10.T", "AC12.N", "AC12.T"), ordered=TRUE)
  
phys.nmds.covariates.plot.data <- data.frame(phys.envi.vectors)
phys.nmds.covariates.plot.data$Covariate<-c(rownames(phys.envi.vectors))
names(phys.nmds.covariates.plot.data)[1:2]<-c("MDS1", "MDS2")
phys.nmds.covariates.plot.data$Covariate
phys.nmds.covariates.plot.data$Metric<-c("Protein_C", "Protein_S", "Biomass_C", "Biomass_S", "Chlorophyll")

```


### Plot NMDS
```{r}
phys.nmds.plot<-ggplot(data = phys.nmds.samples.plot.data, aes(x = MDS1, y = MDS2)) + 
  geom_point(data = phys.nmds.samples.plot.data, aes(colour = Site.Orig, shape=Genotype), size = point.sz-1, alpha = 0.8) + 
  scale_colour_manual(values =Orig.colors.o)+
  scale_shape_manual(values=Geno.shapes.o)+
  theme_classic()+
  scale_x_continuous(limits = c(-1.1, 1.1))+
  scale_y_continuous(limits = c(-1.1, 1.1))+
   theme(axis.title.x = element_text(size = axis.title.sz), 
        axis.title.y = element_text(size = axis.title.sz), 
        axis.text.x=element_text(size=axis.txt.sz, colour="black"),
        axis.text.y=element_text(size=axis.txt.sz, colour="black"),
        legend.text=element_text(size=leg.txt.sz), 
        legend.box.background = element_rect(color = "black"))+
  geom_segment(aes(x = 0, y = 0, xend = MDS1, yend = MDS2), 
               data = phys.nmds.covariates.plot.data, linewidth =bar.sz, alpha = 0.8, colour = "grey30") +
  geom_text(data=phys.nmds.covariates.plot.data, aes(x=MDS1, y=MDS2, label=Metric, fontface = "bold", hjust=0.15*(1-sign(MDS1)),vjust=0.6*(1-sign(MDS2))), colour = "grey20", size=sig.sz)+
  labs(x=paste0('NMDS 1 (',NMDS1,"%)"), y=paste0('NMDS 2 (',NMDS2,"%)"), color="Site.Origin")+
  annotate("text", x = .6, y = -1.1, label = NMDS.stress, hjust=0, size=sig.sz); phys.nmds.plot
```



### Data Prep for SIBER
```{r}
#Prepare data to be input into SIBER
phys.siber.input <- phys.nmds$points %>% #extract 2-D physiology axes from NMDS
  bind_cols(#add back covariates from original phys data
    select(Phys.log, ID:Site.Orig) #select those covariate columns
  ) %>% 
  #SIBER object needs four specific columns
  #iso1, iso2, group, and community
  #Need to manipulate the data to match that format
  #create  group variable that combines site, genotype and origin
  unite("group", c(Site, Genotype, Orig), sep = "_") %>% 
  #rename variables to match names for SIBER
  dplyr::rename(community = TimeP, iso1 = MDS1, iso2 = MDS2) %>% 
  #retain only columns for SIBER
  select(iso1, iso2, group, community)

```


## Run SIBER
Grouping by each genotype at each site, timepoint, and from each origin
```{r}
# create SIBER object
phys.siber.object <- createSiberObject(phys.siber.input)

# sample sizes by group
phys.siber.object[["sample.sizes"]]

# Calculate sumamry statistics for each group: TA, SEA and SEAc
group.ML <- groupMetricsML(phys.siber.object)
print(group.ML)

##Save SIBER Object in Outputs
save(phys.siber.object, file="Outputs/SIBER/Phys.SIBER.Object.RData")
```

### Visualize SIBER Ellipses

```{r}
##Load SIBER Object
load("Outputs/SIBER/Phys.SIBER.Object.RData")


#Create lists of plotting arguments for ellipses
group.ellipses.args  <- list(n = 100, p.interval = 0.95, lty = 1, lwd = 2)

#Plot SIBER groups
plotSiberObject(phys.siber.object,
                  ax.pad = 2, 
                  hulls = F, community.hulls.args, 
                  ellipses = T, group.ellipses.args,
                  group.hulls = F, group.hull.args,
                  bty = "L",
                  iso.order = c(1,2),
                  xlab = "NMDS1", x.limits=c(-1.1, 1.3),
                  ylab = "NMDS2", y.limits=c(-1.2, 1.2))


```


## Ellipses Across Time and Space
Plotting 95% confidence intervals of the physiological niche space for each group.

## By Origin

### KL
```{r}
ellipses.origin.plot_KL<-ggplot(data = phys.nmds.samples.plot.data[which(phys.nmds.samples.plot.data$Site=="KL"),], aes(x = MDS1, y = MDS2)) + 
  stat_conf_ellipse(data = phys.nmds.samples.plot.data[which(phys.nmds.samples.plot.data$Site=="KL"),], geom = "polygon", level = 0.95, alpha = 0.7, aes(fill= Origin))+
  scale_fill_manual(values =Orig.colors.o[1:2])+
  theme_bw()+
   theme(axis.title.x = element_text(size = axis.title.sz), 
        axis.title.y = element_text(size = axis.title.sz), 
        axis.text.x=element_text(size=axis.txt.sz, colour="black"),
        axis.text.y=element_text(size=axis.txt.sz, colour="black"),
        legend.title=element_text(size=leg.title.sz),
        legend.text=element_text(size=leg.txt.sz), 
        legend.box.background = element_rect(color = "black"),
        legend.position="top", 
        strip.text = element_text(size=axis.title.sz), 
        strip.background=element_rect(fill="white"))+
  labs(x=paste0('NMDS 1 (',NMDS1,"%)"), y=paste0('NMDS 2 (',NMDS2,"%)"))+
  facet_wrap(~TimeP, nrow=1); ellipses.origin.plot_KL

```


### SS
```{r}
ellipses.origin.plot_SS<-ggplot(data = phys.nmds.samples.plot.data[which(phys.nmds.samples.plot.data$Site=="SS"),], aes(x = MDS1, y = MDS2)) + 
  stat_conf_ellipse(data = phys.nmds.samples.plot.data[which(phys.nmds.samples.plot.data$Site=="SS"),], geom = "polygon", level = 0.95, alpha = 0.7, aes(fill= Origin))+
  scale_fill_manual(values =Orig.colors.o[3:4])+
  theme_bw()+
   theme(axis.title.x = element_text(size = axis.title.sz), 
        axis.title.y = element_text(size = axis.title.sz), 
        axis.text.x=element_text(size=axis.txt.sz, colour="black"),
        axis.text.y=element_text(size=axis.txt.sz, colour="black"),
        legend.title=element_text(size=leg.title.sz),
        legend.text=element_text(size=leg.txt.sz), 
        legend.box.background = element_rect(color = "black"),
        legend.position="top", 
        strip.text = element_text(size=axis.title.sz), 
        strip.background=element_rect(fill="white"))+
  labs(x=paste0('NMDS 1 (',NMDS1,"%)"), y=paste0('NMDS 2 (',NMDS2,"%)"))+
  facet_wrap(~TimeP, nrow=1); ellipses.origin.plot_SS

```


## By Origin and Genotype
Need to decide the best way to display these.

### KL
```{r}
ellipses.orig.geno.grid_KL<-ggplot(data = phys.nmds.samples.plot.data[which(phys.nmds.samples.plot.data$Site=="KL"),], aes(x = MDS1, y = MDS2)) + 
  stat_conf_ellipse(data = phys.nmds.samples.plot.data[which(phys.nmds.samples.plot.data$Site=="KL"),], geom = "polygon", level = 0.95, aes(fill=Geno.Orig), alpha=0.6)+
  scale_fill_manual(values =Geno.Orig.colors.o)+
  theme_bw()+
   theme(axis.title.x = element_text(size = axis.title.sz), 
        axis.title.y = element_text(size = axis.title.sz), 
        axis.text.x=element_text(size=axis.txt.sz, colour="black"),
        axis.text.y=element_text(size=axis.txt.sz, colour="black"),
        legend.title=element_text(size=leg.title.sz),
        legend.text=element_text(size=leg.txt.sz), 
        legend.box.background = element_rect(color = "black"),
        legend.position="top", 
        strip.text = element_text(size=axis.title.sz), 
        strip.background=element_rect(fill="white"))+
  labs(x=paste0('NMDS 1 (',NMDS1,"%)"), y=paste0('NMDS 2 (',NMDS2,"%)"))+
  facet_grid(Genotype~TimeP); ellipses.orig.geno.grid_KL

```


```{r}
ellipses.orig.geno.plot_KL.a<-ggplot(data = phys.nmds.samples.plot.data[which(phys.nmds.samples.plot.data$Site=="KL"),], aes(x = MDS1, y = MDS2)) + 
  stat_conf_ellipse(data = phys.nmds.samples.plot.data[which(phys.nmds.samples.plot.data$Site=="KL"),], geom = "polygon", level = 0.95,  aes(fill=Geno.Orig), alpha=0.6)+
  scale_fill_manual(values =Geno.Orig.colors.o)+
  theme_bw()+
   theme(axis.title.x = element_text(size = axis.title.sz), 
        axis.title.y = element_text(size = axis.title.sz), 
        axis.text.x=element_text(size=axis.txt.sz, colour="black"),
        axis.text.y=element_text(size=axis.txt.sz, colour="black"),
        legend.title=element_text(size=leg.title.sz),
        legend.text=element_text(size=leg.txt.sz), 
        legend.box.background = element_rect(color = "black"),
        legend.position="top", 
        strip.text = element_text(size=axis.title.sz), 
        strip.background=element_rect(fill="white"))+
  labs(x=paste0('NMDS 1 (',NMDS1,"%)"), y=paste0('NMDS 2 (',NMDS2,"%)"), fill="Genotype.Origin")+
  facet_wrap(~TimeP, nrow=1); ellipses.orig.geno.plot_KL.a
```


```{r}
ellipses.orig.geno.plot_KL.b<-ggplot(data = phys.nmds.samples.plot.data[which(phys.nmds.samples.plot.data$Site=="KL"),], aes(x = MDS1, y = MDS2)) + 
  stat_conf_ellipse(data = phys.nmds.samples.plot.data[which(phys.nmds.samples.plot.data$Site=="KL"),], geom = "polygon", level = 0.95,  aes(fill=Genotype, alpha=Origin))+
  scale_fill_manual(values =Geno.colors.o)+
  scale_alpha_manual(values=c(0.6,0.2))+
  theme_bw()+
   theme(axis.title.x = element_text(size = axis.title.sz), 
        axis.title.y = element_text(size = axis.title.sz), 
        axis.text.x=element_text(size=axis.txt.sz, colour="black"),
        axis.text.y=element_text(size=axis.txt.sz, colour="black"),
        legend.title=element_text(size=leg.title.sz),
        legend.text=element_text(size=leg.txt.sz), 
        legend.box.background = element_rect(color = "black"),
        legend.position="top", 
        strip.text = element_text(size=axis.title.sz), 
        strip.background=element_rect(fill="white"))+
  labs(x=paste0('NMDS 1 (',NMDS1,"%)"), y=paste0('NMDS 2 (',NMDS2,"%)"))+
  facet_wrap(~TimeP, nrow=1); ellipses.orig.geno.plot_KL.b
```


```{r}
ellipses.orig.geno.plot_KL.c<-ggplot(data = phys.nmds.samples.plot.data[which(phys.nmds.samples.plot.data$Site=="KL"),], aes(x = MDS1, y = MDS2)) + 
  stat_conf_ellipse(data = phys.nmds.samples.plot.data[which(phys.nmds.samples.plot.data$Site=="KL" & phys.nmds.samples.plot.data$Orig=="N"),], geom = "polygon", level = 0.95,  aes(fill=Genotype), alpha=0.6)+
   stat_conf_ellipse(data = phys.nmds.samples.plot.data[which(phys.nmds.samples.plot.data$Site=="KL" & phys.nmds.samples.plot.data$Orig=="T"),], geom = "path", level = 0.95,  aes(color=Genotype), linewidth=bar.sz, alpha=0.8)+
  scale_fill_manual(values =Geno.colors.o)+
    scale_colour_manual(values =Geno.colors.o)+
  theme_bw()+
   theme(axis.title.x = element_text(size = axis.title.sz), 
        axis.title.y = element_text(size = axis.title.sz), 
        axis.text.x=element_text(size=axis.txt.sz, colour="black"),
        axis.text.y=element_text(size=axis.txt.sz, colour="black"),
        legend.title=element_text(size=leg.title.sz),
        legend.text=element_text(size=leg.txt.sz), 
        legend.box.background = element_rect(color = "black"),
        legend.position="top", 
        strip.text = element_text(size=axis.title.sz), 
        strip.background=element_rect(fill="white"))+
  labs(x=paste0('NMDS 1 (',NMDS1,"%)"), y=paste0('NMDS 2 (',NMDS2,"%)"))+
  facet_wrap(~TimeP, nrow=1); ellipses.orig.geno.plot_KL.c
```


### SS
```{r}
ellipses.orig.geno.grid_SS<-ggplot(data = phys.nmds.samples.plot.data[which(phys.nmds.samples.plot.data$Site=="SS"),], aes(x = MDS1, y = MDS2)) + 
  stat_conf_ellipse(data = phys.nmds.samples.plot.data[which(phys.nmds.samples.plot.data$Site=="SS"),], geom = "polygon", level = 0.95, aes(fill=Geno.Orig), alpha=0.6)+
  scale_fill_manual(values =Geno.Orig.colors.o)+
  theme_bw()+
   theme(axis.title.x = element_text(size = axis.title.sz), 
        axis.title.y = element_text(size = axis.title.sz), 
        axis.text.x=element_text(size=axis.txt.sz, colour="black"),
        axis.text.y=element_text(size=axis.txt.sz, colour="black"),
        legend.title=element_text(size=leg.title.sz),
        legend.text=element_text(size=leg.txt.sz), 
        legend.box.background = element_rect(color = "black"),
        legend.position="top", 
        strip.text = element_text(size=axis.title.sz), 
        strip.background=element_rect(fill="white"))+
  labs(x=paste0('NMDS 1 (',NMDS1,"%)"), y=paste0('NMDS 2 (',NMDS2,"%)"))+
  facet_grid(Genotype~TimeP); ellipses.orig.geno.grid_SS

```


```{r}
ellipses.orig.geno.plot_SS.a<-ggplot(data = phys.nmds.samples.plot.data[which(phys.nmds.samples.plot.data$Site=="SS"),], aes(x = MDS1, y = MDS2)) + 
  stat_conf_ellipse(data = phys.nmds.samples.plot.data[which(phys.nmds.samples.plot.data$Site=="SS"),], geom = "polygon", level = 0.95,  aes(fill=Geno.Orig), alpha=0.6)+
  scale_fill_manual(values =Geno.Orig.colors.o)+
  theme_bw()+
   theme(axis.title.x = element_text(size = axis.title.sz), 
        axis.title.y = element_text(size = axis.title.sz), 
        axis.text.x=element_text(size=axis.txt.sz, colour="black"),
        axis.text.y=element_text(size=axis.txt.sz, colour="black"),
        legend.title=element_text(size=leg.title.sz),
        legend.text=element_text(size=leg.txt.sz), 
        legend.box.background = element_rect(color = "black"),
        legend.position="top", 
        strip.text = element_text(size=axis.title.sz), 
        strip.background=element_rect(fill="white"))+
  labs(x=paste0('NMDS 1 (',NMDS1,"%)"), y=paste0('NMDS 2 (',NMDS2,"%)"), fill="Genotype.Origin")+
  facet_wrap(~TimeP, nrow=1); ellipses.orig.geno.plot_SS.a
```


```{r}
ellipses.orig.geno.plot_SS.b<-ggplot(data = phys.nmds.samples.plot.data[which(phys.nmds.samples.plot.data$Site=="SS"),], aes(x = MDS1, y = MDS2)) + 
  stat_conf_ellipse(data = phys.nmds.samples.plot.data[which(phys.nmds.samples.plot.data$Site=="SS"),], geom = "polygon", level = 0.95,  aes(fill=Genotype, alpha=Origin))+
  scale_fill_manual(values =Geno.colors.o)+
  scale_alpha_manual(values=c(0.6,0.2))+
  theme_bw()+
   theme(axis.title.x = element_text(size = axis.title.sz), 
        axis.title.y = element_text(size = axis.title.sz), 
        axis.text.x=element_text(size=axis.txt.sz, colour="black"),
        axis.text.y=element_text(size=axis.txt.sz, colour="black"),
        legend.title=element_text(size=leg.title.sz),
        legend.text=element_text(size=leg.txt.sz), 
        legend.box.background = element_rect(color = "black"),
        legend.position="top", 
        strip.text = element_text(size=axis.title.sz), 
        strip.background=element_rect(fill="white"))+
  labs(x=paste0('NMDS 1 (',NMDS1,"%)"), y=paste0('NMDS 2 (',NMDS2,"%)"))+
  facet_wrap(~TimeP, nrow=1); ellipses.orig.geno.plot_SS.b
```


```{r}
ellipses.orig.geno.plot_SS.c<-ggplot(data = phys.nmds.samples.plot.data[which(phys.nmds.samples.plot.data$Site=="SS"),], aes(x = MDS1, y = MDS2)) + 
  stat_conf_ellipse(data = phys.nmds.samples.plot.data[which(phys.nmds.samples.plot.data$Site=="SS" & phys.nmds.samples.plot.data$Orig=="N"),], geom = "polygon", level = 0.95,  aes(fill=Genotype), alpha=0.6)+
   stat_conf_ellipse(data = phys.nmds.samples.plot.data[which(phys.nmds.samples.plot.data$Site=="SS" & phys.nmds.samples.plot.data$Orig=="T"),], geom = "path", level = 0.95,  aes(color=Genotype), linewidth=bar.sz, alpha=0.8)+
  scale_fill_manual(values =Geno.colors.o)+
    scale_colour_manual(values =Geno.colors.o)+
  theme_bw()+
   theme(axis.title.x = element_text(size = axis.title.sz), 
        axis.title.y = element_text(size = axis.title.sz), 
        axis.text.x=element_text(size=axis.txt.sz, colour="black"),
        axis.text.y=element_text(size=axis.txt.sz, colour="black"),
        legend.title=element_text(size=leg.title.sz),
        legend.text=element_text(size=leg.txt.sz), 
        legend.box.background = element_rect(color = "black"),
        legend.position="top", 
        strip.text = element_text(size=axis.title.sz), 
        strip.background=element_rect(fill="white"))+
  labs(x=paste0('NMDS 1 (',NMDS1,"%)"), y=paste0('NMDS 2 (',NMDS2,"%)"))+
  facet_wrap(~TimeP, nrow=1); ellipses.orig.geno.plot_SS.c
```


# Ellipse Overlap

## Calculate Percent Overlap
Calculating the overlap of physiological niche space between corals of the same genotype, at the same site and timepoint. Using Percent of Niche Overlap as a more informative indicator of how similar the Transplant corals are to their Native clonemates. 

First, calculating the area of the 95% prediction ellipses for each group as well as the maximum likelihood of overlap between physiological niche ellipses.

### Calculate Niche Areas
```{r}
Niches<-data.frame(rbind(
  #KL AC10
  maxLikOverlap("TP1.KL_AC10_N", "TP1.KL_AC10_T", phys.siber.object, p = 0.95, n = 360),
  maxLikOverlap("TP2.KL_AC10_N", "TP2.KL_AC10_T", phys.siber.object, p = 0.95, n = 360),
  maxLikOverlap("TP3.KL_AC10_N", "TP3.KL_AC10_T", phys.siber.object, p = 0.95, n = 360),
  maxLikOverlap("TP4.KL_AC10_N", "TP4.KL_AC10_T", phys.siber.object, p = 0.95, n = 360),
  #KL AC12
  maxLikOverlap("TP1.KL_AC12_N", "TP1.KL_AC12_T", phys.siber.object, p = 0.95, n = 360),
  maxLikOverlap("TP2.KL_AC12_N", "TP2.KL_AC12_T", phys.siber.object, p = 0.95, n = 360),
  maxLikOverlap("TP3.KL_AC12_N", "TP3.KL_AC12_T", phys.siber.object, p = 0.95, n = 360),
  maxLikOverlap("TP4.KL_AC12_N", "TP4.KL_AC12_T", phys.siber.object, p = 0.95, n = 360),
  #KL AC8
  maxLikOverlap("TP1.KL_AC8_N", "TP1.KL_AC8_T", phys.siber.object, p = 0.95, n = 360),
  maxLikOverlap("TP2.KL_AC8_N", "TP2.KL_AC8_T", phys.siber.object, p = 0.95, n = 360),
  maxLikOverlap("TP3.KL_AC8_N", "TP3.KL_AC8_T", phys.siber.object, p = 0.95, n = 360),
  maxLikOverlap("TP4.KL_AC8_N", "TP4.KL_AC8_T", phys.siber.object, p = 0.95, n = 360),
  #SS AC10
  maxLikOverlap("TP1.SS_AC10_N", "TP1.SS_AC10_T", phys.siber.object, p = 0.95, n = 360),
  maxLikOverlap("TP2.SS_AC10_N", "TP2.SS_AC10_T", phys.siber.object, p = 0.95, n = 360),
  maxLikOverlap("TP3.SS_AC10_N", "TP3.SS_AC10_T", phys.siber.object, p = 0.95, n = 360),
  maxLikOverlap("TP4.SS_AC10_N", "TP4.SS_AC10_T", phys.siber.object, p = 0.95, n = 360),
  #SS AC12
  maxLikOverlap("TP1.SS_AC12_N", "TP1.SS_AC12_T", phys.siber.object, p = 0.95, n = 360),
  maxLikOverlap("TP2.SS_AC12_N", "TP2.SS_AC12_T", phys.siber.object, p = 0.95, n = 360),
  maxLikOverlap("TP3.SS_AC12_N", "TP3.SS_AC12_T", phys.siber.object, p = 0.95, n = 360),
  maxLikOverlap("TP4.SS_AC12_N", "TP4.SS_AC12_T", phys.siber.object, p = 0.95, n = 360),
  #SS AC8
  maxLikOverlap("TP1.SS_AC8_N", "TP1.SS_AC8_T", phys.siber.object, p = 0.95, n = 360),
  maxLikOverlap("TP2.SS_AC8_N", "TP2.SS_AC8_T", phys.siber.object, p = 0.95, n = 360),
  maxLikOverlap("TP3.SS_AC8_N", "TP3.SS_AC8_T", phys.siber.object, p = 0.95, n = 360),
  maxLikOverlap("TP4.SS_AC8_N", "TP4.SS_AC8_T", phys.siber.object, p = 0.95, n = 360)
  ))

names(Niches)<-c("Native", "Transplant", "Overlap")
Niches$Site<-c(rep("KL", 12), rep("SS", 12))
Niches$Genotype<-c(rep(c(rep("AC10",4), rep("AC12",4), rep("AC8",4)),2))
Niches$TimeP<-rep(c("TP1", "TP2", "TP3", "TP4"),6)

```



### Calculate Overlap
Proportion of niche overlap = Area of overlap between Native and Transplant physiological niches / Area of the Native niche

Using Native niche area as the denominator which may be more informative as the baseline niche space
```{r}
##Proportion of Native Niche Area
Niches$pOverlap<-Niches$Overlap/Niches$Native

##Write out dataframe
write.csv(Niches, "Outputs/SIBER_p.Overlap.csv", row.names=FALSE)

##Read in
Niches<-read.csv("Outputs/SIBER_p.Overlap.csv", header=TRUE)

##Set factor variables
Niches$Site<-factor(Niches$Site, levels=c("KL", "SS"))
Niches$Genotype<-factor(Niches$Genotype, levels=c("AC8", "AC10", "AC12"))
Niches$TimeP<-factor(Niches$TimeP)

```


## Visualize Overlap over Time

### By Genotype
```{r Plot Overlap over Time}
##Plot Niche Overlap across Timepoints
Overlap.plot<-ggplot(Niches, aes(x=TimeP, y=pOverlap, colour=Genotype, group=Genotype)) + 
  geom_line(linewidth=bar.sz)+
  geom_point(size=point.sz)+
  scale_colour_manual(values =Geno.colors.o)+
  theme_classic()+
  theme(axis.title.x = element_text(size = axis.title.sz), 
        axis.title.y = element_text(size = axis.title.sz), 
        axis.text.x=element_text(size=axis.txt.sz, colour="black"),
        axis.text.y=element_text(size=axis.txt.sz, colour="black"), 
        legend.text=element_text(size=leg.txt.sz), 
        legend.title=element_text(size=leg.title.sz), 
        legend.box.background = element_rect(color = "black"),
        strip.text=element_text(size=axis.title.sz))+
  labs(x="Timepoint", y="Physiological Niche Overlap")+
  facet_wrap(~Site); Overlap.plot

##Save Figure
ggsave(filename="Figures/04_SIBER/NicheOverlap.png", plot=Overlap.plot, dpi=300, width=8, height=5, units="in")

```


#### KL
```{r}
##Plot Niche Overlap across Timepoints
Overlap_KL.plot<-ggplot(Niches[which(Niches$Site=="KL"),], aes(x=TimeP, y=pOverlap, colour=Genotype, group=Genotype)) + 
  geom_line(linewidth=bar.sz)+
  geom_point(size=point.sz)+
  scale_colour_manual(values =Geno.colors.o)+
  theme_classic()+
  theme(axis.title.x = element_text(size = axis.title.sz), 
        axis.title.y = element_text(size = axis.title.sz), 
        axis.text.x=element_text(size=axis.txt.sz, colour="black"),
        axis.text.y=element_text(size=axis.txt.sz, colour="black"), 
        legend.text=element_text(size=leg.txt.sz), 
        legend.title=element_text(size=leg.title.sz), 
        legend.box.background = element_rect(color = "black"), 
        legend.position="top")+
  labs(x="Timepoint", y="Physiological Niche Overlap")+
  ylim(0.05,1.05); Overlap_KL.plot
```

#### SS
```{r}
##Plot Niche Overlap across Timepoints
Overlap_SS.plot<-ggplot(Niches[which(Niches$Site=="SS"),], aes(x=TimeP, y=pOverlap, colour=Genotype, group=Genotype)) + 
  geom_line(linewidth=bar.sz)+
  geom_point(size=point.sz)+
  scale_colour_manual(values =Geno.colors.o)+
  theme_classic()+
  theme(axis.title.x = element_text(size = axis.title.sz), 
        axis.title.y = element_text(size = axis.title.sz), 
        axis.text.x=element_text(size=axis.txt.sz, colour="black"),
        axis.text.y=element_text(size=axis.txt.sz, colour="black"), 
        legend.text=element_text(size=leg.txt.sz), 
        legend.title=element_text(size=leg.title.sz), 
        legend.box.background = element_rect(color = "black"), 
        legend.position="top")+
  labs(x="Timepoint", y="Physiological Niche Overlap")+
  ylim(0.05,1.05); Overlap_SS.plot
```


### Across Genotypes
```{r Plot Average Overlap over Time}
##Summary statistics by Site and Origin
pOverlap.sum<-summarySE(Niches, measurevar="pOverlap", groupvars=c("Site", "TimeP"), na.rm=TRUE)

##Plot Average Niche Overlap across Timepoints
Overlap_Avg.plot<-ggplot(pOverlap.sum, aes(x=TimeP, y=pOverlap, colour=Site, group=1)) + 
  scale_colour_manual(values=Site.colors.o)+
  geom_errorbar(aes(ymin=pOverlap-se, ymax=pOverlap+se), width=cap.sz, linewidth=bar.sz) +
  geom_line(linewidth=bar.sz)+
  geom_point(size=point.sz)+
  theme_classic()+
  theme(axis.title.x = element_text(size = axis.title.sz), 
        axis.title.y = element_text(size = axis.title.sz), 
        axis.text.x=element_text(size=axis.txt.sz, colour="black"),
        axis.text.y=element_text(size=axis.txt.sz, colour="black"), 
        legend.position="none",
        strip.text=element_text(size=axis.title.sz))+
  labs(x="Timepoint", y="Physiological Niche Overlap")+
  facet_wrap(~Site); Overlap_Avg.plot

##Save Figure
ggsave(filename="Figures/04_SIBER/AvgNicheOverlap.png", plot=Overlap_Avg.plot, dpi=300, width=6, height=5, units="in")
```


#### KL
```{r}
##Plot Average Niche Overlap across Timepoints
Overlap_Avg_KL.plot<-ggplot(pOverlap.sum[which(pOverlap.sum$Site=="KL"),], aes(x=TimeP, y=pOverlap, colour=Site, group=1)) + 
  scale_colour_manual(values=Site.colors.o[1])+
  geom_errorbar(aes(ymin=pOverlap-se, ymax=pOverlap+se), width=cap.sz, linewidth=bar.sz) +
  geom_line(linewidth=bar.sz)+
  geom_point(size=point.sz)+
  theme_classic()+
  theme(axis.title.x = element_text(size = axis.title.sz), 
        axis.title.y = element_text(size = axis.title.sz), 
        axis.text.x=element_text(size=axis.txt.sz, colour="black"),
        axis.text.y=element_text(size=axis.txt.sz, colour="black"), 
        legend.position="none")+
  labs(x="Timepoint", y="Physiological Niche Overlap")+
  ylim(0.05,1.05); Overlap_Avg_KL.plot

```


#### SS
```{r}
##Plot Average Niche Overlap across Timepoints
Overlap_Avg_SS.plot<-ggplot(pOverlap.sum[which(pOverlap.sum$Site=="SS"),], aes(x=TimeP, y=pOverlap, colour=Site, group=1)) + 
  scale_colour_manual(values=Site.colors.o[2])+
  geom_errorbar(aes(ymin=pOverlap-se, ymax=pOverlap+se), width=cap.sz, linewidth=bar.sz) +
  geom_line(linewidth=bar.sz)+
  geom_point(size=point.sz)+
  theme_classic()+
  theme(axis.title.x = element_text(size = axis.title.sz), 
        axis.title.y = element_text(size = axis.title.sz), 
        axis.text.x=element_text(size=axis.txt.sz, colour="black"),
        axis.text.y=element_text(size=axis.txt.sz, colour="black"), 
        legend.position="none")+
  labs(x="Timepoint", y="Physiological Niche Overlap")+
  ylim(0.05,1.05); Overlap_Avg_SS.plot

```


## Differences in Overlap

### Across Time and Space
```{r}
##Check Normality
hist(Niches$pOverlap)
shapiro.test(Niches$pOverlap)
#Normal

##Model Overlap as a function of Site and Origin, with Genotype as a Random effect
#Interaction between Site and Timepoint
Overlap.lme<-lmer(pOverlap~TimeP*Site+(1|Genotype), data=Niches)

##Check residuals
Overlap.lme_res <- simulateResiduals(fittedModel = Overlap.lme, plot = F)
plot(Overlap.lme_res)

##Model results
summary(Overlap.lme)
anova(Overlap.lme)

```


### Pairwise Comparisons
```{r}
##Timepoints within Sites
emmeans(Overlap.lme, pairwise~TimeP | Site)

##p Values
Overlap.lme.contrast<-data.frame(emmeans(Overlap.lme, pairwise~TimeP | Site)$contrasts)
Overlap.lme.contrast<-Overlap.lme.contrast %>% separate_wider_delim(cols=contrast, names=c("group1", "group2"), delim=" - ", cols_remove=TRUE)
Overlap.lme.contrast$group1<-paste(Overlap.lme.contrast$Site, Overlap.lme.contrast$group1, sep="_")
Overlap.lme.contrast$group2<-paste(Overlap.lme.contrast$Site, Overlap.lme.contrast$group2, sep="_")
```


# Figures

### Figure 2
```{r}
##Create Panel
AvgOverlap_fig<-plot_grid(ellipses.origin.plot_KL, Overlap_Avg_KL.plot, 
                      ellipses.origin.plot_SS, Overlap_Avg_SS.plot,
                    rel_widths=c(1, .4, 1, .4), 
                    rel_heights = c(1, 1, 1, 1),
                    nrow=2, ncol=2, byrow=T, labels = c("A", "B", "C", "D"))

##Save Figure
ggsave(filename="Figures/04_SIBER/Fig2_AvgNicheOverlap.png", plot=AvgOverlap_fig, dpi=300, width=14, height=9, units="in")

```


### Figure S3
```{r}

##Save Figure
ggsave(filename="Figures/04_SIBER/FigS3_PhysiologyNMDS.png", plot=phys.nmds.plot, dpi=300, width=7, height=6, units="in")

```


### Figure S4

#### Adjust Figures for Panel
```{r}
##KL
Overlap_KL.plot.cut<-ggplot(Niches[which(Niches$Site=="KL"),], aes(x=TimeP, y=pOverlap, colour=Genotype, group=Genotype)) + 
  geom_line(linewidth=bar.sz)+
  geom_point(size=point.sz)+
  scale_colour_manual(values =Geno.colors.o)+
  theme_classic()+
  theme(axis.title.x = element_text(size = axis.title.sz), 
        axis.title.y = element_text(size = axis.title.sz), 
        axis.text.x=element_text(size=axis.txt.sz, colour="black"),
        axis.text.y=element_text(size=axis.txt.sz, colour="black"), 
        legend.position="none")+
  labs(x="Timepoint", y="Physiological Niche Overlap")+
  ylim(0.05,1.05)

##SS
Overlap_SS.plot.cut<-ggplot(Niches[which(Niches$Site=="SS"),], aes(x=TimeP, y=pOverlap, colour=Genotype, group=Genotype)) + 
  geom_line(linewidth=bar.sz)+
  geom_point(size=point.sz)+
  scale_colour_manual(values =Geno.colors.o)+
  theme_classic()+
  theme(axis.title.x = element_text(size = axis.title.sz), 
        axis.title.y = element_text(size = axis.title.sz), 
        axis.text.x=element_text(size=axis.txt.sz, colour="black"),
        axis.text.y=element_text(size=axis.txt.sz, colour="black"), 
        legend.position="none")+
  labs(x="Timepoint", y="Physiological Niche Overlap")+
  ylim(0.05,1.05)
```


#### Figure S4
```{r}
##Create Panel
Overlap_fig<-plot_grid(ellipses.orig.geno.plot_KL.b, Overlap_KL.plot.cut, 
                      ellipses.orig.geno.plot_SS.b, Overlap_SS.plot.cut,
                    rel_widths=c(1, .4, 1, .4), 
                    rel_heights = c(1, 1, 1, 1),
                    nrow=2, ncol=2, byrow=T, labels = c("A", "B", "C", "D"))

##Save Figure
ggsave(filename="Figures/04_SIBER/FigS4_NicheOverlap.png", plot=Overlap_fig, dpi=300, width=14, height=9, units="in")

```


# Trying Other Ellipse Plotting Options
Note: to Create SIBER Ellipses, run SIBER_Ellipse.R in Outputs/SIBER
Requires phys.ellipses.posterior created in SIBER_Ellipse.R in Outputs/SIBER

#### Create Ellipse Dataframe
Note: this chunk of code is from the [SIBER package vingette](https://github.com/AndrewLJackson/SIBER/tree/306aa9dc922b9c73dc8223f423e667f11fad844a)
```{r}
##Load SIBER Ellipse Object
load("Outputs/SIBER/Phys.SIBER.Ellipses.RData")

##Create Ellipses
# how many of the posterior draws do you want?
n.posts <- 10

# decide how big an ellipse you want to draw
p.ell <- 0.95

# a list to store the results
all_ellipses <- list()

# loop over groups
for (i in 1:length(phys.ellipses.posterior)){
  
  # a dummy variable to build in the loop
  ell <- NULL
  post.id <- NULL
  
  for ( j in 1:n.posts){
    
    # covariance matrix
    Sigma  <- matrix(phys.ellipses.posterior[[i]][j,1:4], 2, 2)
    
    # mean
    mu     <- phys.ellipses.posterior[[i]][j,5:6]
    
    # ellipse points
    
    out <- ellipse::ellipse(Sigma, centre = mu , level = p.ell)
    
    
    ell <- rbind(ell, out)
    post.id <- c(post.id, rep(j, nrow(out)))
    
  }
  ell <- as.data.frame(ell)
  ell$rep <- post.id
  all_ellipses[[i]] <- ell
}

ellipse_df <- bind_rows(all_ellipses, .id = "id")


# now we need the group and community names

# extract them from the ellipses.posterior list
group_comm_names <- names(phys.ellipses.posterior)[as.numeric(ellipse_df$id)]

# split them and conver to a matrix, NB byrow = T
split_group_comm <- matrix(unlist(strsplit(group_comm_names, "[.]")),
                           nrow(ellipse_df), 2, byrow = TRUE)

ellipse_df$community <- split_group_comm[,1]
ellipse_df$group     <- split_group_comm[,2]

ellipse_df <- dplyr::rename(ellipse_df, iso1 = x, iso2 = y)

```


```{r}
ggplot(data = phys.siber.input, aes(iso1, iso2)) +
  geom_point(aes(color = factor(group):factor(community)), size = 2)+
  xlab("NMDS1")+
  ylab("NMDS2") + 
  theme(text = element_text(size=15), legend.position="none")+
   geom_polygon(data = ellipse_df,
              mapping = aes(iso1, iso2, 
                            group = rep, 
                            color = factor(group):factor(community),
                            fill = NULL),
              fill = NA, alpha = 0.2)+
  facet_wrap(~factor(group):factor(community))
```

This still isn't what we want to show.


### Plot Niche Ellipses
Format data to plot
```{r}
phys.nmds.plot.data <- phys.siber.input %>% 
  separate(group, into = c("Site", "Genotype", "Origin"), sep = "_") %>% 
  mutate(Origin = case_when(
    Origin == "N" ~ "Native",
    Origin == "T" ~ "Transplant"
  )) %>% 
  dplyr::rename(`Time Period`= community, MDS1 = iso1, MDS2 = iso2)
```

Plot by genotype and origin
```{r}
(phys.nmds.ellipses.geno <- ggplot(phys.nmds.plot.data, 
                              aes(x = MDS1, y = MDS2, color = Origin, fill = Genotype))+
    stat_conf_ellipse(geom = "polygon", level = 0.95, alpha = 0.5)+
    facet_grid(Site ~ `Time Period`, scales = "free")+
    scale_fill_viridis_d(end = 0.8)+
    scale_color_viridis_d(end = 0.8, option = "A")+
    theme_bw()
  
)

ggsave(filename="Figures/04_SIBER/NicheEllipseGeno.png", plot=phys.nmds.ellipses.geno, dpi=300, width=10, height=8, units="in")
```

Plot by origin
```{r}
phys.nmds.ellipses.origin <- ggplot(phys.nmds.plot.data, 
                              aes(x = MDS1, y = MDS2, fill = Origin))+
    stat_conf_ellipse(geom = "polygon", level = 0.95, alpha = 0.5)+
    facet_grid(Site ~ `Time Period`, scales = "free")+
    scale_fill_viridis_d(end = 0.8, option = "A")+
    theme_bw(); phys.nmds.ellipses.origin
  


ggsave(filename="Figures/04_SIBER/NicheEllipseOrigin.png", plot=phys.nmds.ellipses.origin, dpi=300, width=10, height=8, units="in")
```

